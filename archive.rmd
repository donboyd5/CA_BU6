---
title: "Untitled"
author: "Don Boyd"
date: "12/28/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




# OLDDetailed econometric models    
## Econometric model of correctional officers' wages vs. other states

In this model, we regress real wages (adjusted for price differences across states) of state correctional officers in the 50 states, in log form, on:

-   Experience (and experience squared - the usual econometric approach)
-   Educational attainment
-   Controls for marital status, sex, race/ethnicity, and which year the person was in the sample (2015-2019)

We also include state fixed effects - essentially a dummy variable for each state.

The state fixed effects are the main result we are interested in. They tell how much a state's correctional officer wages are above or below the U.S. average, in percentage terms (approximately), after controlling for the items above.

```{r acs_corr_models}
# https://cran.r-project.org/web/packages/fixest/fixest.pdf
# https://cran.r-project.org/web/packages/fixest/vignettes/fixest_walkthrough.html

# count(corr_workers, edattain)
# count(corr_workers %>% filter(stabbr=="CA"), edattain)
# count(corr_workers, stabbr2, stabbr)
femod <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) | stabbr2,
               data=corr_workers_cut, notes=FALSE)
# suppress note about dropping edattainother
# keyfacts$statemod <- femod
summary(femod)
tidy(femod)
tidy(femod) %>%
  filter(abs(p.value) < .05)

```

#### Model summary

We begin with a summary of model results. This is a check on things, before we get to the state fixed effects.

(A "fixed effect," in econometrics, is the effect that belonging to a particular category, such as a particular state, is estimated to have on the outcome of interest. In this case, we are interesetd in the effect that being in one state or another has on the wages of correctional officers.)

Easiest just to talk about what the summary table below means, if you are interested.

<!-- To allow for a wider html table in output, put the following html code before the chunk -->
<!-- <div style = "width:120%; height:auto; margin: auto;"> -->
<!-- and the following after the chunk -->
<!-- </div> -->

<div style = "width:120%; height:auto; margin: auto;">
```{r include=TRUE, rows.print=25}
# R.options = list(width = SOME-BIG-VALUE)
# R.options = list(width = 1000)

# To allow for a wider html table in output, put the following html code before the chunk
# <div style = "width:120%; height:auto; margin: auto;">
# and the following after the chunk
# </div>

summary(femod)
# r2(femod, type = "all", full_names = TRUE)  # gives everything
# r2(femod, c("cor2", "r2", "pr2", "war2"), full_names = TRUE) # numbers are not quite the same as from summary
# fitstat(femod, ~ rmse + r2 + wald + wf)

```
</div>


<br> <br> <br>

Now comes another reasonableness check. We graph the coefficients on `exp` and `exp2` to see if wages rise at a slowing rate as workers have more experience (all else equal); usually they will fall at some point, and so we expect the plot to look like an inverted U but with the peak occuring late in career.

```{r include=TRUE}
# check the wage-experience profile for reasonableness
p <- tibble(exp=0:40, exp2=exp^2, e1=exp * coef(femod)["exp"], e2=exp2 * coef(femod)["exp2"]) %>%
  mutate(earn=e1 + e2) %>%
  ggplot(aes(exp, earn)) +
  geom_line() +
  labs(x="Experience (years)", y="Log earnings") +
  scale_x_continuous(breaks=seq(0, 100, 5)) +
  ggtitle("Estimated U.S. average earnings-experience profile for correctional officers") +
  theme_bw()
p

```

#### Key result: differences across states (state fixed effects)

```{r acs_corr_model_results, include=TRUE, fig.width=6, fig.height=8}
# , fig.height=8, fig.width=10
fe <- fixef(femod)
# summary(fe)

# centered fixed effects
cfe <- tibble(stabbr=names(fe$stabbr2), fe=fe$stabbr2) %>%
  mutate(cfe=fe - mean(fe),
         stname=get_stname(stabbr),
         stname=ifelse(stabbr=="other", "Small states as a group", stname),
         rank=rank(desc(cfe)),
         cfepct=exp(cfe) -1) %>%
  arrange(desc(cfepct)) %>%
  mutate(label=ifelse(row_number() <= 5, percent(cfepct, accuracy=.1), ""))
cfe
# keyfacts$statecfe <- cfe

gtitle <- "State correctional officer salaries relative to those in the average state"
gsub1 <- "Controlling for experience, education, and demographic characteristics"
gsub2 <- "Wages adjusted for differences in state cost of living"
gsubtitle <- paste0(gsub1, "\n", gsub2)
capt1 <- paste0("\nSource: ", source_acs, "; and ", source_rpp, ".")
capt2 <- "Note: States with fewer than 50 observations were grouped together."
capt <- paste0(str_wrap(capt1, 100), "\n", capt2)
statefe_dots <- cfe %>%
  # filter(stabbr != "Other") %>%
  mutate(grp=ifelse(stabbr=="CA", "CA", "other")) %>%
  ggplot(aes(y=reorder(stname, cfepct), x=cfepct)) +
  geom_col(aes(fill=grp), size=1.5, width=0.1) +
  geom_point(aes(colour=grp), size=0.75) +
  geom_text(aes(label=label),
            hjust=0, nudge_x=.003, size=2.25) +
  scale_fill_manual(values=c("red", "blue")) +
  scale_colour_manual(values=c("red", "blue")) +
  theme_bw() +
  labs(x="% above or below average state", y=NULL,
       caption=capt) +
  ggtitle(label=gtitle, subtitle = gsubtitle) +
  theme(axis.text.y = element_text(hjust = 0)) +
  geom_vline(xintercept = 0) +
  scale_x_continuous(breaks=seq(-1, 1, .05), labels=label_percent(accuracy=1)) +
  legend_none +
  caption_left

statefe_dots

ggsave(here::here("results", "statefe_bar.png"), plot=statefe_dots, width=10, height=8, scale=1.0)
  
```

## Within-California comparisons


We want to compare wages of California state correctional officers to wages of other workers in California, particularly in the private sector, but how can we do this given that correctional workers:

-   Are mostly (but not always) employed by the government
-   Work in a potentially dangerous and stressful work environment
-   Have firearms training (although they generally do not carry guns on the job)

I take 3 approaches to within-California comparisons:

1.   Compare state government correctional officers to federal and local government correctional officers
2.   Compare state government correctional officers to private sector workers in law, public safety, corrections & security occupations
3.   Compare state government correctional officers to private sector workers in occupations where workers have simlar education attainment

```{r wpius_table}

tabbase <- wpius_5year %>%
  filter(nge5k==5) %>% # must have all 5 years with ftes >= 5k
  arrange(desc(rate_calc)) %>%
  mutate(rank=row_number(),
         stateco=ocode=="333012" & ownf=="state",
         ownf=ifelse(ownf %in% c("state", "local"), paste0(ownf, " gov"), as.character(ownf)),
         label=paste0(oname, " (", ownf, ")"),
         # Delete non-alphanumeric and selected punctuation
         label=str_replace_all(label, "[^[:alnum:] (),-]", ""),
         label=str_replace(label, "sheriffs", "sheriff's"),
         pdvsco=rate_calc / rate_calc[stateco] - 1,
         copdvsother=rate_calc[stateco] / rate_calc - 1)

noccs <- nrow(tabbase)

topn <- 25
tabdata <- tabbase %>%
  filter(rank <= topn | ocode=="333012") %>%
  arrange(rank) %>%
  select(ocode, label, rate_calc, rank, pdvsco)

tab <- tabdata %>%
  gt() %>%
  cols_hide(c(ocode, pdvsco, copdvsother)) %>%
  tab_header(
    title = "Nonfatal workplace injuries and illnesses in the United States, 2015-2019 average",
    subtitle = paste0("Top ", topn, 
                      " occupation-sector combinations, plus correctional officers by sector, out of ",
                      noccs, 
                      " occupation-sector combinations")
      ) %>%
  tab_spanner(label=html("Injuries and illnesses requiring days away from work"),
              columns=c(rate_calc, rank)) %>%
  cols_label(label="",
             rate_calc=html("Rate"),
             rank="Rank"
             ) %>%
  cols_align(align="left", columns = label) %>%
  fmt_number(
    columns=rate_calc,
    pattern = "{x}",
    decimals=1
  ) %>%
  fmt_number(
    columns=rank,
    pattern = "{x}",
    decimals=0
  ) %>%
  tab_source_note(paste0("Source: ", source_wpi, ".")) %>%
  cols_width(
    label ~ px(650),
    everything() ~ px(140)
    ) %>%
  tab_style(
    style = list(
      cell_text(weight = "bold") # size = px(15), , font = "arial"
      ),
    locations = cells_body(
      rows=str_detect(label, "Correctional")
      )
    ) %>%
  tab_footnote(
    footnote = "Per 10,000 full-time equivalent employees, per year.",
    locations = cells_column_labels(columns = rate_calc)
    )
tab
 
# webshot options
# default zoom=2, expand=5
gtsave(tab, filename="tab_wpius.png", path=here::here("results"), zoom=1, expand=10)

```


```{r wpi_us}
count(wpirates, own, ownf)
count(caworkers, cow, cowf)
# 1 prof, 2 nonprof private, 4 state, 3 local, 5 federal
# 1 private, 7 state, 8 local
wpius <- wpirates %>%
  filter(stabbr=="US", year==2019, 
         (ocode=="333012" & own %in% 7:8) | (ocode!="333012" & own==1)) %>%
  rename(wpirate=value) %>%
  mutate(soc=paste0(str_sub(ocode, 1, 2), "-", substr(ocode, 3, length(ocode))),
         cow=case_when(own==1 ~ 1,
                       own==7 ~ 4,
                       own==8 ~ 3,
                       TRUE ~ -99)) %>%
  select(soc, ocode, oname, cow, own, ownf, displevel, wpirate)
count(wpius, cow, own, ownf)

```

### DJB Within-California comparisons: Federal, state, and local government correctional officers

```{r mod_cacorr_fslg_acs}
# wpius %>% 
#   filter(soc=="33-3012")
  
#.. ACS subset for CA FSL regression ----
cacorr_fslacs <- caworkers %>%
  filter(soc=="33-3012", cow %in% 3:5) %>%  # local, state, federal, there are only 11 private obs
  mutate(cowf=factor(cow, levels=c(4, 3, 5), labels=c("state", "local", "federal"))) %>%
  arrange(cowf)

summary(cacorr_fslacs)
count(cacorr_fslacs, cowf)

```


### Econometric model comparing wages of state, local, and federal correctional officers

The following model regresses wages adjusted for regional cost of living differences on experience, education, and demographic characteristics. The sample includes California state government, local government, and federal government correctional officers. It has level-of-government fixed effects.


```{r fsl_mod}
# here is the cross-state model:
# femod <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) | stabbr2,
#                data=corr_workers_cut, notes=FALSE)

cacorr_fslacs
summary(cacorr_fslacs)
count(cacorr_fslacs, cow, cowf)

camod_fsl <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp + factor(year) | cowf,
               data=cacorr_fslacs, notes = FALSE)
summary(camod_fsl)
count(cacorr_fslacs, cowf)

```

Get state-centric fixed effects
```{r fsl_fe}
fe <- fixef(camod_fsl)
cfe <- fe$cowf - mean(fe$cowf)
# summary(fe)

# centered fixed effects
cfe <- tibble(cowf=names(fe$cowf), fe=fe$cowf) %>%
  mutate(cfe=fe - mean(fe),
         cfepct=exp(cfe) -1,
         state_vsother=(1 + cfepct[cowf=="state"]) / (1 + cfepct) - 1) %>%
  arrange(desc(cfepct))
cfe

tab <- cfe %>%
  filter(cowf %in% c("local", "federal")) %>%
  select(cowf, state_vsother) %>%
  mutate(cowf=factor(cowf, 
                     levels=c("local", "federal"), 
                     labels=c("Local government", "Federal government"))) %>%
  gt() %>%
  tab_header(
    title = html("California state correctional officer wage premium<br>versus local and federal correctional officers")
      ) %>%
  cols_label(cowf="Employer",
             state_vsother=html("Premium vs. other<br>level of government")
             ) %>%
  cols_align(align="left", columns = cowf) %>%
  fmt_percent(
    columns=state_vsother,
    # pattern = "{x}",
    decimals=1
  ) %>%
  tab_source_note(paste0("Source: ", source_acs, ".")) %>%
  tab_footnote("Adjusted for within-state cost-of-living differences and controlling for education, experience, and demographic characteristics.",
               locations = cells_column_labels(columns = state_vsother)) %>%
  cols_width(
    cowf ~ pct(40),
    everything() ~ pct(60)
    ) %>%
  tab_options(
    table.width = pct(50)
  )
 tab
# webshot options
# default zoom=2, expand=5
gtsave(tab, filename="tab_fslpremium.png", path=here::here("results"), zoom=2, expand=5)
  
```

### Descriptive analysis

##### Wages over time - state, local, and federal government correctional officers (OES)

```{r corrca_fsl, include=TRUE}

pdata <- oesres_clean %>%
  filter(occ=="33-3012", stabbr=="CA", level %in% c("federal", "state", "local")) %>%
  mutate(level=str_to_sentence(level),
         level=factor(level, levels=c("Federal", "State", "Local"))) %>%
  arrange(year, level)
# keyfacts$oesres_cafsl <- pdata

capt <- paste0("\nSource: ", source_oesres)
colors <- c('#e41a1c','#377eb8','#4daf4a')
p <- pdata %>%
  ggplot(aes(year, amean, colour=level)) +
  geom_line(size=1.0) +
  geom_point() +
  scale_colour_manual(values=colors) +  # c("green", "blue", "black")
  labs(y="Average annual wage", x=NULL,
       caption=capt) +
  scale_y_continuous(breaks=seq(0, 100e3, 10e3),
                     labels = label_comma(accuracy=1),
                     limits=c(0, NA)) +
  ggtitle("Correctional officers' salaries in California by level of government") +
  theme_bw() +
  legend_notitle +
  caption_left
p

ggsave(here::here("results", "wages_corrca_fsl.png"), plot = p,
       width=10, height=8, scale=1)

```

##### Wages in 2020 - state, local, and federal correctional officers in California (OES)

The table below shows wages of California federal, state, and local correctional officers using data from BLS Occupational Employment Statistics (OES). Because those data are for the state as a whole, we can't adjust for within-state cost-of-living differences but they are a useful benchmark.

Note that these data show a substantial wage premium for state correctional officers in California vs. local and federal government correctional officers in California, but:

+   The premium is greater than the premium we see in the American Community Survey (ACS) in the next section.
+   The premium is less than the premium vs. local and federal government that CalHR estimated in their 2015 compensation study of 2013 wages (see p.28 of that report).

I don't yet know why that should be so.

Regarding the difference versus the ACS:

+   The ACS is a pooled sample of people surveyed by the Census Bureau in 2015-2019 that asks about their income for the prior year (i.e., 2014-2018), and I use an adjustment factor Census provides to adjust all incomes to the final year (2019). So the ACS values I show are wages in 2019 dollars of people who worked in 2014-2018. ACS wages are defined as total money earnings from employment and so include straight time pay as well as overtime, and they include clothing allowances, shift differentials, and other similar items.

+   The OES is based on a pooled sample of employers, not workers. It is conducted by the Bureau of Labor Statistics, not the Census Bureau. The data for 2020 are pooled by BLS from 6 separate samples collected over the prior 3 years, ending in May 2020. BLS adjusts the data to be at May 2020 income levels. OES wages are defined as straight-time, gross pay and do not include overtime pay, clothing allowances, shift differentials, and other similar items.

+   So we are comparing ACS data for a comprehensive definition of wages, paid in 2014-2018 (adjusted to 2019), as remembered and reported by workers, with OES data for a narrower definition of wages paid during early 2018 through early 2020 (adjusted to 2020), as reported by employers based on their books and records.

+   There are a lot of reasons why the two data sources could differ. In concept, ACS wages are closer to what we care about, but OES wages come from a more reliable source (employers' books and records) and will be a better measure of total employment, and of wages as defined by OES (but that leaves out a lot of what we care about). At this point, I am not sure why the relationships among state, federal, and local correctional officers differ between the two sources as they do.

Regarding the difference versus CalHR:

+   CalHR used unpublished data from their own records. I will ask them for this, updated, but don't expect to get it.

+   I used the OES "research database" because it breaks down federal, state, and local whereas the OES regular data do not. I have sent an email to BLS to try to get more details on their methodology for this source.

+   I suspect the unpublished data from CalHR will be more reliable than the BLS OES research database but need to investigate more.


```{r include=TRUE}
df <- oesres_clean %>% 
  filter(stabbr=="CA", year==2020, occ=="33-3012", level %in% c("federal", "state", "local"))

tabdata <- df %>%
  select(level, emp, amean) %>%
  mutate(level=str_to_title(level),
         level=factor(level, levels=c("State", "Local", "Federal")),
         premium=amean[level=="State"] / amean - 1) %>%
  arrange(level)

tab <- tabdata %>% 
  gt() %>%
  tab_header(
    title = "Summary statistics for correctional officers in California in 2020 (OES)",
    subtitle = "By level of government"
      ) %>%
  cols_label(level="Level of government",
             emp="# of employees",
             amean="Average wage",
             premium=md("State correctional officer premium relative to<br>local and federal correctional officers")) %>%
  fmt_number(
    columns=c(emp, amean),
    decimals=0
  ) %>%
  fmt_percent(
    columns = c(premium),
    decimals = 1) %>%
  tab_source_note(paste0("Sources: ", source_oesres, "; and ", source_rpp, "."))

tab


```



##### Education, experience, wages, and within-California cost-of-living adjustment (ACS)

The table below compares education, experience, and wages of state, local, and federal correctional officers in California.

The two rightmost columns show the "premium" that state correctional officers are paid relative to local and federal correctional officers in California. (These are raw summary statistics and therefore do not control for education, experience, or other worker characteristics.)

Note that the premium is greater after we adjust for within-California cost-of-living differences. This suggests that state correctional officers tend to live in relatively less-expensive areas of California than either local or federal officers. This is not surprising, at least relative to local - we'd expect jails to be spread out around the state, including in expensive metro areas, but states often place prisons in more-rural and therefore likely less-expensive areas (I have not checked this for California). California does not, as far as I can tell, provide geographic pay differentials for correctional officers. (The federal government does.)

If California prison guards are paid the same wage regardless of where they work, and if they tend to work disproportionately in less-expensive areas, then the price-adjusted pay differential is likely to be greater than the unadjusted differential.


```{r include=TRUE}

# What if we only look at the latest year?
# cacorr_fslacs %>%
#   filter(year==2019) %>%
#   group_by(cowf) %>%
#   summarise(n=n(), wtdn=sum(pwgtp), 
#             rwagp=wtd.mean(rwagp, weights = pwgtp),
#             rppwagp=wtd.mean(rppwagp, weights = pwgtp),
#             yoschool=wtd.mean(yoschool, weights = pwgtp),
#             exp=wtd.mean(exp, weights = pwgtp)) %>%
#   mutate(irwagp=rwagp[cowf=="state"] / rwagp - 1,
#          irppwagp=rppwagp[cowf=="state"] / rppwagp - 1)


# descriptive statistics
sumstats <- cacorr_fslacs %>%
  group_by(cowf) %>%
  summarise(n=n(), wtdn=sum(pwgtp), 
            rwagp=wtd.mean(rwagp, weights = pwgtp),
            rppwagp=wtd.mean(rppwagp, weights = pwgtp),
            yoschool=wtd.mean(yoschool, weights = pwgtp),
            exp=wtd.mean(exp, weights = pwgtp)) %>%
  mutate(irwagp=rwagp[cowf=="state"] / rwagp - 1,
         irppwagp=rppwagp[cowf=="state"] / rppwagp - 1)

tabdata <- sumstats %>%
  select(cowf, yoschool, exp, rwagp, irwagp, irppwagp) %>%
  mutate(cowf=str_to_sentence(cowf))

# keyfacts$cafsl_edexp <- tabdata

tab <- tabdata %>% 
  gt() %>%
  tab_header(
    title = "Summary statistics for correctional officers in California (ACS)",
    subtitle = "By level of government"
      ) %>%
  cols_label(cowf="Level of government",
             yoschool="Education",
             exp="Experience",
             rwagp=md("Average wage<br>2019 income level"),
             irwagp="Unadjusted",
             irppwagp="Price-adjusted") %>%
  tab_spanner(
    label = "Average years of:",
    columns = c(yoschool, exp)
    ) %>%
  tab_spanner(
    label = md("State correctional officer premium relative to<br>local and federal correctional officers"),
    columns = c(irwagp, irppwagp)
    ) %>%
  fmt_number(
    columns=c(yoschool, exp),
    decimals=1
  ) %>%
  fmt_number(
    columns=c(rwagp),
    decimals=0
  ) %>%
  fmt_percent(
    columns = c(irwagp, irppwagp),
    decimals = 1) %>%
  tab_source_note(paste0("Sources: ", source_acs, "; and ", source_rpp, "."))

tab

```
<br>
<br>
    
    

<!-- To allow for a wider html table in output, put the following html code before the chunk -->
<!-- <div style = "width:120%; height:auto; margin: auto;"> -->
<!-- and the following after the chunk -->
<!-- </div> -->

##### Model summary
<div style = "width:120%; height:auto; margin: auto;">
```{r include=TRUE}
summary(camod_fsl)

```
</div>


##### Key result: California state correctional officer wages vs. local and federal, after controls

State correctional wages are about 17-18% higher than those of local and federal workers, after adjusting for within-California price differences, and controlling for education, experience, and demographic characteristics.


```{r include=TRUE}
fe <- fixef(camod_fsl)

fefsl_df <- tibble(level=names(fe$cowf), fe=fe$cowf) %>%
  mutate(pdstate=fe[level=="state"] - fe,
         level=str_to_title(level),
         level=factor(level, levels = c("State", "Local", "Federal"))) %>%
  arrange(level)
# keyfacts$fefsl_df <- fefsl_df

fefsl_df %>%
  select(-fe) %>%
  gt() %>%
  tab_header(
    title = md("California state correctional officer wages vs.<br>those of federal and local correctional officers"),
    subtitle=md("After controlling for education, experience, and demographic characteristics<br>Wages adjusted for regional cost of living differences.")
      ) %>%
  cols_label(level="Level of government",
             pdstate=md("State correctional officer premium")) %>%
  fmt_percent(
    columns = c(pdstate),
    decimals = 1) %>%
  tab_source_note(paste0("Sources: ", source_acs, "; and ", source_rpp, "."))

  
```


### Within-California comparisons: Law, Public Safety, Corrections & Security job cluster

Here we compare California *state* correctional officers' wages, adjusted for regional cost of living, with wages of California *private sector* workers in the [Law, Public Safety, Corrections & Security job cluster](https://www.onetonline.org/find/career?c=12&g=Go).

I have collapsed occupations with fewer than 50 workers into an all-other group, giving us state correctional officers and private sector workers in 13 other Law, Public Safety, Corrections & Security occupations.

<br>
<br>
    
    
#### Econometric model

The following model regresses wages adjusted for regional cost of living differences on experience, education, and demographic characteristics. The sample includes (1) California state correctional officers, and (2) California private-sector workers in the Law, Public Safety, Corrections & Security job cluster. It has occupation fixed effects.


```{r}
count(caworkers, cow, cowf)

# define logical expression to use later for filtering
corr_vs_private <- expression((cow==4 & soc=="33-3012") | # state govt corr officers
           (cow %in% 1:2 & soc!="33-3012"))  # only private for the non-corr observations

cacluster_df <- caworkers %>%
  filter((cow==4 & soc=="33-3012") | 
           (cow %in% 1:5 & soc!="33-3012")) %>%
  filter(eval(corr_vs_private)) %>%
  left_join(job_cluster %>% 
              select(soc=occ, clust_occname=occname) %>% 
              mutate(incluster=TRUE),
            by="soc") %>%
  filter(incluster)  %>%
  left_join(ihus_5year %>% 
              select(soc, cow, ihrate=rate_calc), by = c("cow", "soc")) %>%
  mutate(edattain=fct_drop(edattain), # drop unused factor levels
         cowf=fct_drop(cowf),
         ihrate=ifelse(is.na(ihrate), 0, ihrate)) %>%
  group_by(soc, occname) %>%
  mutate(n=n(),
         occgroup=ifelse(n < obs_cutoff, "lowobs", occname)) %>%
  ungroup

summary(cacluster_df)
count(cacluster_df, soc, occgroup, clust_occname)

count(cacluster_df, cowf)
count(cacluster_df, soc, occname)
count(cacluster_df, occgroup)

check <- count(cacluster_df, soc, occgroup, occname)
sum(check$n)

```

#### Stats on job clusters
```{r}
glimpse(cacluster_df)
summary(cacluster_df)
count(cacluster_df, occgroup)
quantile(cacluster_df$ihrate)
count(cacluster_df, occgroup, ihrate)
count(cacluster_df, occgroup, occname, ihrate)

cacluster_df %>%
  group_by(occgroup) %>%
  summarise(n=n(), wtdn=sum(pwgtp),
            exp=wtd.mean(exp, weights = pwgtp),
            ihrate=wtd.mean(ihrate, weights = pwgtp))

count(cacluster_df, occgroup, cowf) %>% pivot_wider(names_from = cowf, values_from = n)

```



##### Model summary
<!-- To allow for a wider html table in output, put the following html code before the chunk -->
<!-- <div style = "width:120%; height:auto; margin: auto;"> -->
<!-- and the following after the chunk -->
<!-- </div> -->
<div style = "width:120%; height:auto; margin: auto;">

```{r include=TRUE}

camod_cluster <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp +
                         as.factor(year) | occgroup,
               data=cacluster_df %>% filter(eval(corr_vs_private)))
summary(camod_cluster)

# the model with intentional harm injury rate is no good because when limited to 
# state cos vs private sector it is almost all zero for the privates so it is 
# almost like a fixed effect
camod_cluster_ih <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp +
                          ihrate + 
                          # I(ihrate^2) + # collinear
                          as.factor(year) | occgroup,
               data=cacluster_df %>% filter(eval(corr_vs_private)))

summary(camod_cluster)
summary(camod_cluster_ih)

```
</div>


##### Key result: California state correction officers' wages relative to California private sector wages in the same cluster}

Note: I am still investigating this cluster - it may make sense to drop out several very low-paying jobs that probably are not alternatives to correctional officer.

```{r include=TRUE, fig.width=8, fig.height=8}

fecamod_cluster <- fixef(camod_cluster)

# centered fixed effects
cfe <- tibble(occname=names(fecamod_cluster$occgroup), fe=fecamod_cluster$occgroup) %>%
  mutate(cfe=fe - mean(fe),
         rank=rank(desc(cfe)),
         cfepct=exp(cfe) -1) %>%
  arrange(desc(cfepct)) %>%
  mutate(label=ifelse(row_number() <= 5, percent(cfepct, accuracy=.1), ""))
cfe

gtitle <- "California state correctional officer wages relative to private sector wages for jobs in the same occupational cluster"
gsubtitle <- "Adjusted for Metropolitan Statistical Area (MSA) price levels, and controlling for experience, education, and demographic characteristics"
capt1 <- paste0("\nSource: ", source_acs, ".")
capt2 <- paste0("Price adjustments using ", source_rpp, ".")
capt3 <- "Note: Occupations with fewer than 50 observations were grouped together."
capt <- paste0(capt1, "\n", capt2, "\n", capt3)

jobcluster_bar <- cfe %>%
    mutate(grp=str_detect(occname, "Correctional officers"),
         occname=ifelse(grp, paste0(occname, " (state government)"), occname),
         occname=ifelse(occname=="lowobs", "Low-observation occupations as a group", occname)) %>%
  ggplot(aes(y=reorder(str_wrap(occname, 25), cfepct), x=cfepct)) +
  geom_col(aes(fill=grp), size=1.5, width=0.1) +
  geom_point(aes(colour=grp), size=0.75) +
  geom_text(aes(label=label),
            hjust=0, nudge_x=.003, size=2.25) +
  scale_fill_manual(values=c("blue", "red")) +
  scale_colour_manual(values=c("blue", "red")) +
  theme_bw() +
  labs(x="% above or below average job in cluster", y=NULL,
       caption=capt) +
  ggtitle(label=gtitle, subtitle = gsubtitle) +
  theme(axis.text.y = element_text(hjust = 0)) +
  geom_vline(xintercept = 0) +
  scale_x_continuous(breaks=seq(-1, 1, .05), labels=label_percent(accuracy=1)) +
  legend_none +
  caption_left

jobcluster_bar

# use scale adjustment to fit title into png file
ggsave(here::here("results", "jobcluster_bar.png"), plot=jobcluster_bar, width=10, height=8, scale=1.15)
  
```



### OLD Econometric model within California, state correctional officers vs. law enforcement, all sectors


```{r model_table}
# table
tabdata <- cfe %>% 
  left_join(cacluster_acs_sum, by = "occgroup") %>%
  left_join(cluster_oes %>% select(soc=occ, level, emp, wage) %>% distinct,
            by = c("soc", "level")) %>%
  arrange(desc(rwagp_avg)) %>%
  select(soc, occgroup, emp, wtdn, rwagp_avg, wage, cfepct, exp_avg, geassoc_avg)

tabdata %>%
  select(occgroup, rwagp_avg, cfepct, emp, exp_avg, geassoc_avg) %>%
  arrange(desc(rwagp_avg)) %>%
  gt() %>%
  tab_header(
    title = "California jobs in the Law, Public Safety, Corrections & Security job cluster",
    subtitle=""
      ) %>%
  # cols_label(soc=md("Code"),
  #            oname_acs=md("Occupation"),
  #            occ_ltassoc=md("% of workers in this<br>occupation with less than<br>an associate's degree"),
  #            wpirate=md("Workplace injury rate")) %>%
  fmt_percent(
    columns = c(cfepct, geassoc_avg),
    decimals = 1) %>%
  fmt_number(
    columns = c(emp, rwagp_avg),
    decimals = 0) %>%
  fmt_number(
    columns = c(exp_avg),
    decimals = 1)

```



```{r model_bar}

gtitle <- "California state correctional officer wages relative to wages for jobs in the same occupational cluster"
gsubtitle <- "Adjusted for Metropolitan Statistical Area (MSA) price levels, and controlling for experience, education, and demographic characteristics"
capt1 <- paste0("\nSource: ", source_acs, ".")
capt2 <- paste0("Price adjustments using ", source_rpp, ".")
capt3 <- "Note: Occupations with fewer than 50 observations were grouped together."
capt <- paste0(capt1, "\n", capt2, "\n", capt3)

jobclusterall_bar <- cfe %>%
    mutate(grp=str_detect(occgroup, "Correctional officers"),
         occgroup=ifelse(grp, paste0(occgroup, " (state government)"), occgroup),
         occgroup=ifelse(occgroup=="lowobs", "Low-observation occupations as a group", occgroup)) %>%
  ggplot(aes(y=reorder(str_wrap(occgroup, 25), cfepct), x=cfepct)) +
  geom_col(aes(fill=grp), size=1.5, width=0.1) +
  geom_point(aes(colour=grp), size=0.75) +
  geom_text(aes(label=label),
            hjust=0, nudge_x=.003, size=2.25) +
  scale_fill_manual(values=c("blue", "red")) +
  scale_colour_manual(values=c("blue", "red")) +
  theme_bw() +
  labs(x="% above or below average job in cluster", y=NULL,
       caption=capt) +
  ggtitle(label=gtitle, subtitle = gsubtitle) +
  theme(axis.text.y = element_text(hjust = 0)) +
  geom_vline(xintercept = 0) +
  scale_x_continuous(breaks=seq(-1, 1, .05), labels=label_percent(accuracy=1)) +
  legend_none +
  caption_left

jobclusterall_bar

# use scale adjustment to fit title into png file
# ggsave(here::here("results", "jobcluster_bar.png"), plot=jobcluster_bar, width=10, height=8, scale=1.15)

```




##### Alternative model including workplace injuries
<!-- To allow for a wider html table in output, put the following html code before the chunk -->
<!-- <div style = "width:120%; height:auto; margin: auto;"> -->
<!-- and the following after the chunk -->
<!-- </div> -->
<div style = "width:120%; height:auto; margin: auto;">

```{r include=TRUE}
camod_cluster_wpi <- feols(lrppwagp ~ wpirate + exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) | occgroup,
               data=cacluster_df)
summary(camod_cluster_wpi)
```
</div>

##### Alternative: California state correction officers' wages relative to California private sector wages in the same cluster with workplace injury rate control

We lose a lot of workers and occupations when we include workplace injury controls.


```{r include=TRUE, fig.width=8, fig.height=8}
# , fig.width=10, fig.height=8
fecamod_cluster_wpi <- fixef(camod_cluster_wpi)

cfe <- tibble(occname=names(fecamod_cluster_wpi$occgroup), fe=fecamod_cluster_wpi$occgroup) %>%
  mutate(cfe=fe - mean(fe)) %>% 
  arrange(desc(cfe))

gtitle <- "ALTERNATIVE: California state correctional officer wages relative to private sector wages for jobs in the same occupational cluster"
gsubtitle <- "Adjusted for Metropolitan Statistical Area (MSA) price levels, and controlling for experience, education, and demographic characteristics"
capt1 <- paste0("\nSource: ", source_acs, ".")
capt2 <- paste0("Price adjustments using ", source_rpp, ".")
capt3 <- "Note: Occupations with fewer than 50 observations were grouped together."
capt <- paste0(capt1, "\n", capt2, "\n", capt3)
occfe_wpi_dots <- cfe %>%
  mutate(grp=str_detect(occname, "Correctional officers"),
         occname=ifelse(grp, paste0(occname, " (state government)"), occname),
         occname=ifelse(occname=="lowobs", "Low-observation occupations as a group", occname)) %>%
  ggplot(aes(y=reorder(str_wrap(occname, 25), cfe), x=cfe * 100)) +  # str_wrap(occname, 30) occname
  geom_point(aes(colour=grp), size=1.5) +
  geom_vline(xintercept = 0) +
  scale_y_discrete(name=NULL) + # , expand = c(.05, .1)
  scale_x_continuous(name="% above or below cluster average", breaks=seq(-100, 100, 5)) +
  scale_colour_manual(values=c("blue", "red")) +
  theme_bw() +
  labs(caption=capt) +
  ggtitle(label=str_wrap(gtitle, 100), subtitle = str_wrap(gsubtitle, 100)) +
  theme(axis.text.y = element_text(hjust = 0)) +
  theme(aspect.ratio = 4/5) +
  legend_none +
  caption_left
  # theme(plot.title = element_textbox(hjust = 0.5,
  #                                width = unit(0.5, "npc"),
  #                                margin = margin(b = 15))  )

# expand = c(0, 0.3)
occfe_wpi_dots

# ggsave(here::here("results", "occfe_dots.png"), 
#        plot=occfe_dots, width=10, height=8, scale=1.25)
  

```



### Within-California comparisons: Occupations with similar educational attainment

Here we compare California *state* correctional officers' wages, adjusted for regional cost of living, with wages of California *private sector* workers in occupations where the percentage of workers with less than an associate's degree is within +/- 5 percentage points of the percentage for state correctional officers (therefore, we compare to occupations where roughly 68-78 percent of the workers have less than an associate's degree).

I have collapsed occupations with fewer than 50 workers into an all-other group.

The main thing I still want to do here, if I can, is control for the fact that correctional officer jobs are purported to be more stressful and dangerous than many other jobs. In addition, they require some skills and training that many other jobs do not - in particular, correctional officers in California require firearms training although, from all I have read, unlike police officers they do not carry firearms on the job (in part because they can be used against the correctional officers).

I have not found good measures of job stress by occupation. There is a good measure of workplace injuries that result in days away from work. Correctional officer jobs are quite dangerous by this measure. I include this measure in one of the regressions below.


```{r mod_caflsg}
df <- caworkers %>%
  filter(soc=="33-3012")
  filter((cow==4 & soc=="33-3012") | 
           (cow %in% 1:2 & soc!="33-3012"))
count(df, cow)
  
```


```{r}
corred_workers_cut <- caworkers %>%
  filter((cow==4 & soc=="33-3012") | 
           (cow %in% 1:2 & soc!="33-3012")) %>%
  left_join(wpius %>% select(soc, cow, wpirate), by = c("cow", "soc")) %>%
  group_by(soc, occname) %>%
  mutate(nocc=n(),
         occgroup=ifelse(nocc >= obs_cutoff, occname, "other"))  %>%
  group_by(occgroup) %>%
  mutate(occ_ltassoc=wtd.mean(ltassoc, weights = pwgtp))

glimpse(corred_workers_cut)
corred_workers_cut %>%
  group_by(occgroup) %>%
  summarise(nocc=first(nocc),
            ltassocmin=min(occ_ltassoc),
            ltassocmax=max(occ_ltassoc),
            .groups="drop")  # 0.7286963395	
corr_ltassoc  # 0.7286963	

corred_ltassoc_const <- corr_ltassoc %>% filter(stabbr2=="CA") %>% .$ltassoc

cacorr_ed <- corred_workers_cut %>%
  filter(occ_ltassoc >= (corred_ltassoc_const - .05),
         occ_ltassoc <= (corred_ltassoc_const + .05))
summary(cacorr_ed)

```

#### Descriptive statistics

##### Measures of workplace injuries resulting in days away from work

```{r}
#.. THIS CAN BE IMPROVED (10/23/2021) -- FIX MISMATCHES ----

# bring in education from caworkers where we have it
cawed <- corred_workers_cut %>% 
  ungroup %>%
  select(soc, oname_acs=occname, occ_ltassoc) %>%
  distinct()

count(corred_workers_cut %>% ungroup, cow, cowf)
count(wpius %>% filter(soc=="33-3012"), cow)

wpius_cawed <- wpius %>%
  filter(!(soc=="33-3012" & cow==3)) %>% # FOR NOW drop local correctional officers
  full_join(cawed, by="soc") %>%
  mutate(invar=case_when(!is.na(oname) & !is.na(oname_acs) ~ "in_both",
                         is.na(oname) ~ "not_wpi",
                         is.na(oname_acs) ~ "not_acs",
                         TRUE ~ "ERROR")) %>%
  select(soc, oname, oname_acs, wpirate, occ_ltassoc, invar) %>%
  arrange(desc(wpirate))

wpius_cawed %>%
  mutate(inwpi=!is.na(oname),
         incawed=!is.na(oname_acs)) %>%
  group_by(inwpi, incawed) %>%
  summarise(n=n(), .groups="drop")

# based on analysis of mismatches, map wpi codes to acs for acs vars that don't have wpi
xwalk <- read_csv("
acs, wpi
11-10XX, 	11-1010
11-3012, 	11-3010
11-3013, 	11-3010
11-3111, 	11-3121

")  # figure out how to make this efficient -- Excel

comps <- wpius_cawed %>%
  filter(invar=="in_both") %>%
  mutate(corr=occ_ltassoc[soc=="33-3012"]) %>%
  filter(occ_ltassoc >= corr - .05, occ_ltassoc <= corr + .05) %>%
  select(-corr, -invar)

```


Among occupations where workers have similar educational attainment, California state correctional officers have the highest rate of workplace injury resulting in days away from work. [According to BLS](https://www.bls.gov/iif/oshwc/osh/case/cd_r98_2019.htm), "Days-away-from-work cases include those that resulted in days away from work, some of which also included job transfer or restriction ... The incidence rates represent the number of injuries and illnesses per 10,000 full-time workers." (Note that the rate is a rate of injuries per worker in a single year.)

```{r wpi_table, include=TRUE}

comps %>%
  mutate(oname_acs=ifelse(soc=="33-3012", paste0(oname_acs, " (state government)"), oname_acs)) %>%
  select(soc, oname_acs, occ_ltassoc, wpirate) %>%
  arrange(desc(wpirate)) %>%
  gt() %>%
  tab_header(
    title = "National workplace injury rates in 2019 for occupations where California private-sector workers have educational attainment similar to that of California state correctional officers",
    subtitle="Rate of workplace injuries that result in days away from work"
      ) %>%
  cols_label(soc=md("Code"),
             oname_acs=md("Occupation"),
             occ_ltassoc=md("% of workers in this<br>occupation with less than<br>an associate's degree"),
             wpirate=md("Workplace injury rate")) %>%
  fmt_percent(
    columns = c(occ_ltassoc),
    decimals = 1) %>%
  fmt_number(
    columns = c(wpirate),
    decimals = 1) 

```


<br>
<br>

#### Econometric model (primary)

The following model regresses wages adjusted for regional cost of living differences on experience, education, and demographic characteristics. The sample includes (1) California state correctional officers, and (2) California private-sector workers in occupations where the percentage of California workers with less than an associate's degree is within +/- 5 percentage points of the percentage for California state correctional officers. It has occupation fixed effects.


##### Model summary
<!-- To allow for a wider html table in output, put the following html code before the chunk -->
<!-- <div style = "width:120%; height:auto; margin: auto;"> -->
<!-- and the following after the chunk -->
<!-- </div> -->

<div style = "width:120%; height:auto; margin: auto;">
```{r include=TRUE}
camod_educ <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) | occgroup,
               data=cacorr_ed)
summary(camod_educ)

```
</div>

##### Key result: California state correction officers' wages relative to California private sector wages, similar education
```{r include=TRUE, fig.width=10, fig.height=12}

fecamod_educ <- fixef(camod_educ)

cfe <- tibble(occname=names(fecamod_educ$occgroup), fe=fecamod_educ$occgroup) %>%
  mutate(cfe=fe - mean(fe)) %>% 
  arrange(desc(cfe))

# keyfacts$caeduccfe <- cfe

gtitle <- "California state correctional officer wages relative to private sector wages for jobs with similar education attainment"
gsubtitle <- "Adjusted for Metropolitan Statistical Area (MSA) price levels, and controlling for experience, education, and demographic characteristics"
capt1 <- paste0("\nSource: ", source_acs, ".")
capt2 <- paste0("Price adjustments using ", source_rpp, ".")
capt3 <- "Note: Occupations with fewer than 50 observations were grouped together."
capt <- paste0(capt1, "\n", capt2, "\n", capt3)
educfe_dots <- cfe %>%
  # filter(stabbr != "Other") %>%
  mutate(grp=str_detect(occname, "Correctional officers"),
         occname=ifelse(grp, paste0(occname, " (state government)"), occname),
         occname=str_wrap(occname, 45)) %>%
  ggplot(aes(y=reorder(occname, cfe), x=cfe * 100)) +
  geom_point(aes(colour=grp), size=1.5) +
  scale_colour_manual(values=c("blue", "red")) +
  theme_bw() +
  labs(x="% above or below group average", y=NULL,
       caption=capt) +
  ggtitle(label=str_wrap(gtitle, 100), subtitle = str_wrap(gsubtitle, 100)) +
  theme(axis.text.y = element_text(hjust = 0)) +
  geom_vline(xintercept = 0) +
  scale_x_continuous(breaks=seq(-100, 100, 5)) +
  theme(aspect.ratio = 1.75) +
  legend_none +
  caption_left

educfe_dots

ggsave(here::here("results", "educfe_dots.png"),
       plot=educfe_dots, width=10, height=8, scale=1.25)

```


#### Alternative model: Estimate California effect with and without workplace injury rates

Compare the coefficient on corrdumTRUE when the workplace injury rate (wpirate) is not included, and when it is included.

A large drop in coefficient on corrdumTRUE after including wpirate would suggest that much of the higher correctional pay is related to the occupation's high rate of injury. Lack of such a drop would suggest that workforce injury rates do not have a big impact on wages.

We see only a very small drop.


```{r}
cacorr_ed_alt <- cacorr_ed %>%
  rename(wpirate2=wpirate) %>% 
  right_join(comps %>% select(soc, wpirate), by="soc") %>%
  mutate(corrdum=soc=="33-3012")
summary(cacorr_ed_alt)

camod_educ_xwpi <- feols(lrppwagp ~ corrdum + exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year),
               data=cacorr_ed_alt)



camod_educ_wpi <- feols(lrppwagp ~ corrdum + wpirate + exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year),
               data=cacorr_ed_alt)


```

##### Model summary:  WITHOUT including workplace injury rates
<!-- To allow for a wider html table in output, put the following html code before the chunk -->
<!-- <div style = "width:120%; height:auto; margin: auto;"> -->
<!-- and the following after the chunk -->
<!-- </div> -->
<div style = "width:120%; height:auto; margin: auto;">
```{r include=TRUE}
summary(camod_educ_xwpi)
```
</div>

##### Model summary:  INCLUDING workplace injury rates
<!-- To allow for a wider html table in output, put the following html code before the chunk -->
<!-- <div style = "width:120%; height:auto; margin: auto;"> -->
<!-- and the following after the chunk -->
<!-- </div> -->
<div style = "width:120%; height:auto; margin: auto;">
```{r include=TRUE}
summary(camod_educ_wpi)
```
</div>

# Benefits of correctional officers

[TO COME]

2.  Benefits



# Appendix: Data preparation


## Benefits

### National compensation Survey
```{r}
# https://www.bls.gov/ebs/

# flat files
# https://download.bls.gov/pub/time.series/nb/   # national compensation survey 2010+ in flat files


# https://download.bls.gov/pub/time.series/eb  # employee benefits survey 1985 to 2006
# some information by region see https://download.bls.gov/pub/time.series/eb/eb.title

```


### Employer Costs for Employee Compensation

```{r}

# https://www.bls.gov/news.release/ecec.nr0.htm

# https://www.bls.gov/news.release/ecec.tn.htm
# Employer Costs for Employee Compensation (ECEC), a product of the National
# Compensation Survey, provides the average employer cost for wages and salaries
# as well as benefits per employee hour worked. The ECEC covers the civilian
# economy, which includes data from both private industry and state and local
# government. Excluded from private industry are the self-employed, agricultural
# workers, and private household workers. Federal government workers are
# excluded from the public sector.

# Total benefit costs consist of five major categories and include 18 benefit costs:
# * Paid leave - vacation, holiday, sick, and personal leave; 
# * Supplemental pay - overtime and premium, shift differentials, and nonproduction bonuses; 
# * Insurance - life, health, short-term and long-term disability; 
# * Retirement and savings - defined benefit and defined contribution; and 
# * Legally required benefits - Social Security (refers to Old-Age, Survivors, and Disability
#   Insurance (OASDI) program), Medicare, federal and state unemployment insurance, and Workers’
#   Compensation.





```


# OLD and Miscellaneous

```{r include=FALSE}
# Number of correction officers per capita and average wage, not interesting
pdata <- corr_oes %>%
  filter(year==2020) %>%
  left_join(spop.a %>%
              filter(year==2020) %>%
              select(stabbr, pop=value),
            by=c("stabbr")) %>%
  mutate(epop100k=emp / (pop / 100e3))

pdata %>%
  ggplot(aes(epop100k, wage, label=stabbr)) +
  geom_point() +
  geom_text()

```


### Wages in California relative to other states, over time, based on the OES

```{r oes_ts, include=TRUE, fig.width=6, fig.height=8}
# count(corr_oes, stabbr)
pdata <- corr_oes %>%
  filter(stabbr %in% c("US", "CA", compstates)) %>%
  group_by(year) %>%
  mutate(pdwage=wage / wage[stabbr=="US"] * 1 - 1,
         stname=get_stname(stabbr)) %>%
  ungroup %>%
  filter(stabbr != "US")

# cols <- c('#a6cee3','#1f78b4','black','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6')
cols <- c('#a6cee3','red', 'black','#33a02c','#fb9a99','#1f78b4','#fdbf6f','#ff7f00','#cab2d6')

capt1 <- paste0("\nSource: ", source_oesres, ".")
capt2 <- "Note: Not adjusted for price differences across states."
capt <- paste0(capt1, "\n", capt2)

p <- pdata %>%
  ggplot(aes(year, pdwage, colour=stabbr)) +
  geom_line(size=1.0) +
  geom_point() +
  geom_hline(yintercept = 0) +
  scale_colour_manual(values=cols) +
  # scale_size_manual(values=c(1, rep(.5, 8))) +
  labs(y="% above or below U.S. average", x=NULL,
       caption=capt) +
  scale_y_continuous(breaks=seq(-1, 1, .05), labels = label_percent(accuracy=1)) +
  ggtitle("State correctional officers' salaries relative to U.S. average",
          subtitle="California, neighbors, and selected other states") +
  theme_bw() +
  legend_notitle +
  caption_left
p

```


#  Appendix: Notes
<!-- ## OES data -->

```{r epi_data}
# https://www.epi.org/data/methodology/

```


```{r california_policy_center}
# https://www.hoover.org/research/140000-year-why-are-government-workers-california-paid-twice-much-private-sector-workers

# According to the study, public-sector workers typically receive 14 paid holidays, 12 personal days, and 20 or more vacation days, depending on seniority, which tends to be higher than in the private sector.

```


```{r appendix_oes_notes}
# https://www.bls.gov/oes/oes_con.htm
# Two types of OEWS estimates can be downloaded directly from this website in Excel (XLS) format:
# 
# Occupational employment and wage estimates by geographic area (national, state, metropolitan, and nonmetropolitan area)
# National Occupational employment and wage estimates by industry (sector, 3-, 4-, and selected 5- and 6-digit North American Industry Classification System levels)
# Download Occupational Employment and Wage Estimates
# 
# In addition to the estimates that can be downloaded directly from this website, historical OEWS estimates are available upon request through the contact information above. Historical OEWS estimates consist of the 1988 to 1995 national occupational employment and wage data by industry, for most industries at the 2- and 3-digit Standard Industrial Classification (SIC) levels. Estimates for 1988 - 1995 contain only employment data. Between 1988 and 1995 covered industries were surveyed once in a three-year cycle. The OEWS program now surveys all covered industries each year.
# 
# Note: 1996 estimates are not available.
# 
# OEWS State Employment and Wage Estimates
# Occupational Employment and Wage Statistics estimates, by occupation and by industry, for individual states are available from the states' Labor Market Information (LMI) or Research, Analysis, and Statistics offices which are part of their State Employment Security Agencies (SESAs). Availability, format and medium of the data varies by state. To obtain OEWS estimates for a particular state, please contact the appropriate office on the State Contact List.
```



```{r}
# main oes data
# Hi, I'm looking for OES data for states, and possible metro areas, ideally in a single file. I have found the year-by-year state Excel files (https://www.bls.gov/oes/tables.htm) which are awkward to work with but not a bad last resort, and I have found the link for the new OEWS-titled data (https://download.bls.gov/pub/time.series/oe/) but that is only for the latest release. I was hoping you have the historical data in a single csv or flat ASCII file, for all years and states (and maybe metro areas). Would you have a link to a download site for these data? Many thanks in advance. Don Boyd

```


 
```{r bls_research}
#.. BLS state research estimates ----
# https://www.bls.gov/oes/current/oes_research_estimates.htm
# The OEWS program provides wage and employment estimates by state and industry
# beginning with the May 2012 reference period. These estimates are intended for
# research purposes, and users should be aware of the limitations of the data.
# Estimates prior to May 2012 are not available. Estimates are only available
# for states; industry-specific estimates for metropolitan areas are not
# available. Estimates are only available for detail and major occupation
# groups; industry-specific estimates for broad and minor occupation groups are
# not available.
oes <- readRDS(paste0(resdir, "oesres_sec99.rds"))
glimpse(oes)
count(oes, own_code, o_group)
count(oes, naics_title)

# get 1st-line supervisors and corrections officers
# 33-1011	First-Line Supervisors of Correctional Officers	High school diploma or equivalent
# 33-3012	Correctional Officers and Jailers	High school diploma or equivalent
corr <- oes %>%
  filter(occ %in% c("33-1011", "33-3012"),
         !str_detect(naics_title, "Federal")) %>%
  mutate(level=case_when(str_detect(naics_title, "State") ~ "state",
                         str_detect(naics_title, "Local") ~ "local",
                         TRUE ~ "ERROR"))
count(corr, level, own_code, o_group)
count(corr, naics_title)
count(corr, year, level) %>% pivot_wider(names_from = level, values_from = n)
corr %>% filter(stabbr=="CA", year==2012)
corr %>% filter(is.na(stabbr))
count(corr, stabbr)
summary(corr)  # annual has no data

corr2 <- corr %>%
  filter(stabbr %in% state.abb) %>%
  select(year, occ, occname, stabbr, area=area_title, level, emp=tot_emp, awage=a_mean, awage_mdn=a_median)

corr2 %>% filter(stabbr=="CA")


```

<!-- ## Graphs and tables of OES research -->

```{r}

corr2 %>%
  filter(year==2020) %>%
  select(year, occ, occname, stabbr, level, awage) %>%
  pivot_wider(names_from = level, values_from = awage) %>%
  group_by(occ) %>%
  mutate(across(c(state, local), list(rank = ~ rank(-.x)))) %>%
  ungroup %>%
  arrange(occ, state_rank)

cols <- c('#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6')
cols <- c('#a6cee3','#1f78b4','black','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6')

p <- corr2 %>%
  filter(occ=="33-3012", stabbr %in% compstates, level=="state") %>%
  mutate(cadum=ifelse(stabbr=="CA", 1, 0) %>% as.factor) %>%
  arrange(desc(cadum), area) %>%
  ggplot(aes(year, awage / 1000, colour=area)) +
  geom_line(size=1.0) +
  geom_point() +
  scale_colour_manual(values=cols) +
  # scale_size_manual(values=c(1, rep(.5, 8))) +
  labs(y="Average annual wage ($thousands)", x=NULL,
       caption=paste0("Source: ", source_oesres, ".")) +
  scale_y_continuous(breaks=seq(0, 200, 10), labels = scales::dollar, limits=c(0, NA)) +
  ggtitle("Average annual salaries of state correctional officers",
          subtitle="California, neighbors, and selected other states") +
  theme_bw() +
  theme(legend.title = element_blank(),
        plot.caption = element_text(hjust = 0))
p
ggsave(here::here("results", "oes_wages.png"), plot = p,
       width=10, height=8, scale=1)


```

<!-- ## Education requirements -->

```{r}
# https://www.bls.gov/oes/additional.htm
# The typical education level required to enter an occupation is based on education and training categories from the BLS Employment Projections program. Because of changes to the occupational classification system that began with the May 2019 OEWS estimates and because the entry-level educational requirements assigned to some occupations have changed, the May 2020 OEWS data by typical-entry level educational requirement are not directly comparable to OEWS typical entry-level education data prior to 2019. The May 2020 estimates are based primarily on the system of education and training requirements used for the 2018-2028 employment projections.

# https://www.bls.gov/oes/2020/may/education_2020.xlsx
# 33-1011	First-Line Supervisors of Correctional Officers	High school diploma or equivalent
# 33-3012	Correctional Officers and Jailers	High school diploma or equivalent

# ONETIME
# ujobed <- "https://www.bls.gov/oes/2020/may/education_2020.xlsx"
# download.file(url=ujobed, destfile=here::here("data_raw", "education_2020.xlsx"), mode="wb")
# END ONETIME

jobed1 <- read_excel(here::here("data_raw", "education_2020.xlsx"), sheet = "educ_list", skip=3)
jobed <- jobed1 %>%
  setNames(c("occ", "occname", "entryed"))
count(jobed, entryed)
jobed %>%
  filter(str_sub(occ, 1, 2)=="33")

# get 2020 records in CA for HS jobs
# hsjobs <- jobed %>%
#   filter(entryed=="High school diploma or equivalent")
# 
# oeshs1 <- readRDS(paste0(resdir, "oesres_allsectors.rds")) %>%
#   filter(stabbr=="CA", year==2020, occ %in% hsjobs$occ)
# 
# oeshs2 <- oeshs1 %>%
#   filter(tot_emp >= 1000, i_group=="sector") %>%
#   select(stabbr, year, occ, occname, naics, naics_title, i_group, tot_emp, h_mean, a_mean) %>%
#   arrange(-a_mean)
# 
# 
# oeshs3 <- oeshs1 %>%
#   filter(tot_emp >= 10000, i_group=="sector", 
#          !str_detect(occname, coll("supervisor", ignore_case = TRUE))) %>%
#   select(stabbr, year, occ, occname, naics, naics_title, i_group, tot_emp, h_mean, a_mean) %>%
#   arrange(-a_mean)
# 
# # collapse by occupation ----
# oeshs_mean <- oeshs2 %>%
#   filter(i_group=="sector", 
#          !str_detect(occname, coll("supervisor", ignore_case = TRUE))) %>%
#   mutate(totwage=tot_emp * a_mean) %>%
#   group_by(stabbr, year, occ, occname) %>%
#   summarise(tot_emp=sum(tot_emp), totwage=sum(totwage), .groups = "drop") %>%
#   mutate(awage=totwage / tot_emp) %>%
#   arrange(-awage)
# summary(oeshs_mean)
# 
# tabdata <- oeshs_mean %>%
#   filter(tot_emp >= 10000) %>%
#   arrange(-awage) %>%
#   mutate(rank=row_number()) %>%
#   select(rank, occ, occname, tot_emp, awage)

# alternative approach to tabdata
tabbase <- 
  readRDS(paste0(resdir, "oesres_allsectors.rds")) %>%
  filter(stabbr=="CA", year==2020) %>%# my alternative
  filter(i_group=="sector", !is.na(a_mean), !is.na(tot_emp)) %>% # djb verify this
  select(stabbr, year, occ, occname, naics, naics_title, i_group, tot_emp, h_mean, a_mean) %>%
  # collapse by occupation
  filter(i_group=="sector") %>%
  # filter(!str_detect(occname, coll("supervisor", ignore_case = TRUE))) %>%
  mutate(totwage=tot_emp * a_mean) %>%
  group_by(stabbr, year, occ, occname) %>%
  summarise(tot_emp=sum(tot_emp), totwage=sum(totwage), .groups = "drop") %>%
  mutate(awage=totwage / tot_emp)


# get top 20 jobs by employment plus all other
pct_ltassoc <- 70
ncats <- 40
minemp <- 5000
# 	53-7062
tabdata <- tabbase %>%
  left_join(hscodes %>%
              select(occ=occ2, pct), by="occ") %>%
  filter(pct >= pct_ltassoc) %>%
  arrange(desc(tot_emp)) %>%
  mutate(erank=row_number(),
         # pick one or the other of the following
         keep=ifelse(erank <= ncats, TRUE, FALSE),
         # keep=ifelse(tot_emp >= minemp, TRUE, FALSE),
         # now use it
         egroup=ifelse(keep, erank, 999),
         occ=ifelse(keep, occ, ""),
         occname=ifelse(keep, occname, "  All other")) %>%
  group_by(keep, stabbr, year, occ, occname) %>%
  summarise(tot_emp=sum(tot_emp), totwage=sum(totwage), .groups = "drop") %>%
  mutate(awage=totwage / tot_emp,
         premium=awage[occ=="33-3012"] / awage - 1) %>%
  arrange(desc(keep), -awage) %>%
  mutate(rank=ifelse(keep, row_number(), NA_real_)) %>%
  select(rank, occ, occname, tot_emp, awage, premium)
tabdata

count(tabdata, keep)

tab <- tabdata %>%
  gt() %>%
  tab_header(
    title = "Occupations in California where typical entry education requirement is a high school diploma",
      subtitle = "Public and/or private sector occupations with at least 10,000 employees"
      ) %>%
  cols_label(rank="Rank",
             occ=md("Code"),
             occname=md("Occupation"),
             tot_emp=md("Employment  
                        in 2020"),
             awage=md("Average wage  
                      in 2020")) %>%
  # tab_spanner(
  #   label = "Rate adjustment:",
  #   columns = c(actual, adjust)
  #   ) %>%
  fmt_number(
    columns = c(tot_emp),
    decimals = 0) %>%
  fmt_currency(
    columns = c(awage),
    decimals = 0) %>%
  tab_style(
    style = list(
      cell_fill(color = "lightgrey")
      ),
    locations = cells_body(
      rows=c(1)
      )
    ) %>%
  tab_source_note(paste0("Source: ", source_oesres, "."))
  # tab_footnote(
  #   footnote = "Source: Bureau of Labor Statistics Occupational Employment and Wage Statistics, Research Database.",
  #   locations = cells_title(groups = "title")
  #   )

tab
# gtsave(tab, filename="hspay.png", path=here::here("results"))
gtsave(tab, filename="hspay_v2.html", path=here::here("results"))


# Most criminal investigators and detectives earn an associate degree in criminal justice or law enforcement, and some earn a bachelor's degree. Most graduate from a police training academy and work as police officers to gain law enforcement experience. A promotion is often required to become a criminal investigator.

#djb: While BLS says that Detectives and Criminal Investigators (the highest paying HS job on the list) typically need a HS diploma for entry, CalHR (https://www.calhr.ca.gov/state-hr-professionals/pages/8610.aspx) says all levels of the criminal investigator series need to have the equivalent of at least 2 years of college. 


# California Correctional Officer requirements
# https://www.cdcr.ca.gov/por/minimum-qualifications-2/minimum-qualifications/
# Graduation from a U.S. high school, G.E.D. or equivalent from a U.S. institution, or a California High School Proficiency Examination (CHSPE) certificate is required, or possession of a college degree (Associate of Arts or higher) from an accredited college or university.

#.. CalHR job requirements ----
# Correctional officer
# https://www.calhr.ca.gov/state-hr-professionals/Pages/9662.aspx
# Education: Equivalent to completion of the twelfth grade.

# Investigator Series
# https://www.calhr.ca.gov/state-hr-professionals/pages/8610.aspx
# Education requirements are more stringent but it is possible to substitute experience for education.
# For example, one of the education requirements is:
# Education: Equivalent to completion of two years of college with a major in criminal justice, law enforcement, criminology, administration of justice, police science, or a comparable field of study. (Additional qualifying experience may be substituted for the required education on a year-for-year basis. Applicants who are being considered for Investigator positions assigned as Peace Officer status (as defined by California state law) must possess the educational equivalent to completion of the twelfth grade.) and


# BLS ----
# https://www.onetonline.org/link/summary/33-3051.00  Police and detectives etc...
# Job Zone: Education	Most occupations in this zone require training in vocational schools, related on-the-job experience, or an associate's degree.

# https://www.onetonline.org/link/summary/33-3012.00 Correctional officer
# Education	These occupations usually require a high school diploma.

# https://www.onetonline.org/link/summary/11-3071.00 Transportation, Storage, and Distribution Managers
# Education	Most of these occupations require a four-year bachelor's degree, but some do not.


```

<!-- ### Education data development -->

```{r}
# find jobs with similar education requirements to corrections officers
edir <- r"(E:\data\CA_BU6_project\db_26_0_excel\)"
fnecats <- "Education, Training, and Experience Categories.xlsx"
fneoccs <- "Education, Training, and Experience.xlsx"

ecats1 <- read_excel(paste0(edir, fnecats), sheet=1)
eoccs1 <- read_excel(paste0(edir, fneoccs), sheet=1)

catnames <- c("elid", "elname", "scaleid", "scalename", "cat", "catdesc")
ecats <- ecats1 %>%
  setNames(catnames)

ednames <- c("occ", "occname", "elid", "elname", "scaleid", "scalename", "cat", "pct",
             "n", "se", "lci", "uci", "recsuppress", "date", "domain")
eoccs <- eoccs1 %>%
  setNames(ednames)

#.. edoccs 33-3012.00 ----
# create factors for education
edcodes <- ecats %>%
  filter(scaleid=="RL") %>%
  # create short labels
  mutate(catlabel=case_when(cat == 3 ~ "Post-Secondary Certificate",
                            cat == 7 ~ "Post-Baccalaureate Certificate",
                            cat == 9 ~ "Post-Master's Certificate",
                            cat == 10 ~ "First Professional Degree",
                            TRUE ~      catdesc))

edoccs <- eoccs %>%
  filter(scaleid=="RL") %>%
  select(occ, occname, cat, pct, recsuppress, n) %>%
  left_join(edcodes %>% select(cat, catlabel), by="cat")

# hsjobs <- edoccs %>%
#   filter(cat==2, pct>=80)
# hsjobs %>% 
#   arrange(desc(pct))

# hscodes <- edoccs %>%
#   filter(cat==2, pct>=70) %>%
#   mutate(occ2=str_sub(occ, 1, 7)) %>%
#   .$occ2

hscodes <- edoccs %>%
  filter(cat %in% c(1, 2)) %>%
  group_by(occ, occname) %>%
  summarise(pct=sum(pct), n=sum(n), .groups = "drop") %>%
  mutate(occ2=str_sub(occ, 1, 7)) %>%
  arrange(desc(pct))

hscodes %>% filter(str_detect(occ, "53-7062")) # djb figure this out!!
# also this
# 1-3031.01
# Treasurers and Controllers
# 0.00
# 50
# 11-3031
# 10
# 11-3031.03
# Investment Fund Managers
# 0.00
# 50
# 11-3031
  
hscodes %>% filter(str_detect(occname, "Correction"))  
  

```

<!-- ## Descriptive statistics from Cal OES -->

```{r}
count(cal_oes, wtype)
count(cal_oes, atype)


base <- 2009
dflong <- cal_oes %>%
  filter(soc=="333012", wtype=="annual", atype=="state") %>%
  pivot_longer(cols=wage:wp90) %>%
  group_by(name) %>%
  mutate(ivalue=value / value[year==base] * 100 - 100,
         cagr2009=(value / value[year==2009])^(1 / (year - 2009)) * 100 - 100,
         cagr2012=(value / value[year==2012])^(1 / (year - 2012)) * 100 - 100,
         cagr2016=(value / value[year==2016])^(1 / (year - 2016)) * 100 - 100)


cal_oes %>%
  filter(soc=="333012", wtype=="annual", atype=="state") %>%
  ggplot(aes(year, wage)) +
  geom_line() +
  geom_point()

dflong %>%
  ggplot(aes(year, ivalue, colour=name)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(breaks=seq(-50, 50, 5)) +
  geom_hline(yintercept = 0)

dflong %>%
  ggplot(aes(year, cagr2016, colour=name)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(breaks=seq(-50, 50, 0.5)) +
  geom_hline(yintercept = 0)

dflong %>%
  filter(year >= 2012) %>%
  ggplot(aes(year, cagr2012, colour=name)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(breaks=seq(-50, 50, 0.5)) +
  geom_hline(yintercept = 0)


```

<!-- ## Notes about other studies -->

<!-- ### Hedonic wage regressions -->

```{r eval=FALSE}
# Biggs Illinois
# The sample is limited to individuals who work for the state government or for the private sector; federal employees or employees of non-profits are excluded. The sample also is limited to individuals who work 35 or more hours per week and 50 or more weeks per year. The model used here controls for: Years of education; Undergraduate degree field (for those with a college education and above); Potential work experience (equal to age minus years of education minus 6) and experience-squared; Broad occupation (eight categories); place of residence (based upon the Census Bureau’s Public Use Microdata Areas, or PUMAs); Usual hours of work per week; Gender; Race; Hispanicity; Marital status; Immigrant status; Year; and State government employee. Our model has several key differences that can influence the results. First, we control for the number of hours worked per week. Since Illinois state government employees work about 1.5 fewer hours per week than private sector workers, excluding weekly hours worked makes state government employees appear relatively less well paid. Second, we include a variable for the employee’s undergraduate college major, acknowledging that certain majors lead to higher pay in the workforce than others….Third, we include data on the location within the state in which the employee lives.

# Biggs Illinois
# Wages - hedonic (human capital) - ACS controls vs above:
#   state gov penalty of about 2%, w/no firm size adjustment (add'l penalty of 7.2% if firm size adjust)


```

<!-- ### Benefits -->

```{r}
# Biggs Illinois
# p.4 notes they received unpublished ECEC in Biggs and Richwine (2014),
#   for private workers and a small number of public benefits
#   HC, RHC, and pensions drawn from specific sources
# HC:
#   IL -- Pew 2014 -- about 42% higher than private (implies ~ 20.2% of salaries I think)
#   private -- ECEC -- about 14.2% of salaries (must be for region)
# RHC:
#   IL -- NC from AV, div salaries, gives 19.4% 
#   private --  (not in the ECEC)
#     based on Biggs Richwine, which adjusted CBO, data -- nationally 0.5% NC, IL 0.48%
# Pensions:
#   IL -- tot NC of 20.9% adjusted to 41.8% using DR of 5.0% vs. earnings assump of 7.25% (appears
#         to assume 32.7 year - perhaps full career?), less eec of 5.4%,
#         leaving er NC of 36.4%
#   private -- ECEC -- er contribs of 2.6 to DC + 1.4 to DB = 4.0 erc, vs 36.4% public
# Other FB (paid leave - vacation, holiday, personal time); emp prem for life, DB; legally req
#           benefits wf wno AA rZWAM nXewm YUm QX:
#   IL -- ECEC (for region)
#   private -- ECEC (for region)

# Biggs Richwine
# HC: 
  # Our principal source is data compiled by the National Conference of State
  # Legislatures (NCSL).37 These data show monthly employer and employee health
  # premiums for individual and family coverage in 2012. In certain cases, data
  # for 2012 were not available through the NCSL. In these cases we used NCSL
  # data from prior years, adjusted upward by the rate of growth of overall
  # health premiums through 2012. In several other cases, we obtained data
  # directly from state sources, such as budget documents.
#  NCS useful


```


```{r OLD}

```

<!-- # OLD -->

<!-- #### Where California corrections officers live, vs. other California workers -->

```{r}
# quick look at workers by msa
count(caworkers, occp, occname)
places <- caworkers %>%
  mutate(co=ifelse(occp==3802, "co", "other")) %>%
  group_by(co, msacode, msaname, rpp) %>%
  summarise(wtdn=sum(pwgtp), .groups="drop") %>%
  group_by(co) %>%
  mutate(pct=wtdn / sum(wtdn)) %>%
  select(-wtdn) %>%
  ungroup %>%
  pivot_wider(names_from = co, values_from = pct) %>%
  mutate(diff=co - other) %>%
  arrange(-abs(diff))
places
  # arrange(-other)
# need to collapse by county! Or MSA?

place_plot <- places %>%
  ggplot(aes(rpp, diff, label=msaname)) +
  geom_point(colour="blue", size=1) +
  geom_text(colour="blue", size=2) +
  geom_vline(xintercept = 1) +
  geom_hline(yintercept = 0) +
  labs(x="Relative cost of area", y="Relative number of correctional officers") +
  theme_bw() +
  ggtitle("Correctional officers tend to live in less-expensive areas than California workers overall")
place_plot  

```

```{r place_table, include=TRUE}
tabdata <- places %>%
  mutate(msaname=ifelse(msacode==-9999, " -- Non-metro areas", str_replace(msaname, ", CA", "")),
         rpp=ifelse(msacode==-9999, 99.8/100, rpp),  # the CA non metro value in 2017
         rpppct=rpp - 1) %>%
  select(msacode, msaname, rpppct, co, other) %>%
  arrange(rpppct) %>%
  mutate(cotot=cumsum(co), othertot=cumsum(other))
oddrows <- seq(1, nrow(tabdata), 2)

lowrows <- tabdata %>% 
  mutate(rownum=row_number()) %>%
  filter(rpppct < 0)

tab <- tabdata %>%
  gt() %>%
  cols_hide(
    columns = c(msacode)
  ) %>%
  tab_header(
    title = "Cost of Living Where Correctional Officers Live, Relative to Other California Workers",
    subtitle = "Arranged from lowest-cost to highest-cost area"
      ) %>%
  cols_label(msaname="Area of residence",
             rpppct=md("Price level<br>% above/below<br>national average"),
             co=md("Correctional<br>officers"),
             other=md("All other<br>California workers"),
             cotot=md("Correctional<br>officers"),
             othertot=md("All other<br>California workers")) %>%
  tab_spanner(
    label = "% of workers who live in this area",
    columns = c(co, other)
    ) %>%
  tab_spanner(
    label = "Cumulative % of workers",
    columns = c(cotot, othertot)
    ) %>%
  fmt_percent(
    columns = c(rpppct, co, other, cotot, othertot),
    decimals = 1) %>%
  # fmt_percent(
  #   columns = c(rpppct),
  #   decimals = 4) %>%
  tab_style(
    style = list(
      cell_fill(color = "grey95")
      ),
    locations = cells_body(
      rows=oddrows
      )
    ) %>%
  tab_style(
    style = list(
      cell_fill(color = "lightcyan"),
      cell_text(weight = "bold")
      ),
    locations = cells_body(
      columns = c(cotot, othertot),
      rows = msaname=="Chico"  # (rpppct > -.001) & (rpppct < .001)
      )
  ) %>%
  tab_footnote(
    footnote = "Area with prices closest to national average.",
    locations = cells_body(
      columns = c(msaname),
      rows = msaname=="Chico"  # (rpppct > -.001) & (rpppct < .001)
      )
    ) %>%
  tab_source_note(paste0("Sources: ", source_acs, "; and ", source_rpp, "."))
tab
gtsave(tab, filename="residence_and_prices.html", path=here::here("results"))

```

<!-- ### Education -->

```{r rows.print=25}
# what are HS jobs?

summary(cajobeduc)
tmp <- cajobeduc %>% filter(str_sub(soc, 1, 3)=="33-")
# hsjobs <- jobeduc %>%
#   filter(ltassocpct >= .55)

caworkers2 <- caworkers %>%
  left_join(cajobeduc %>%
              select(occp, cow, ltassoc, assoc, ba, maplus),
            by=c("occp", "cow"))

tmp <- caworkers2 %>%
  filter(ltassoc >= .7, ltassoc <= .8)

tmp2 <- tmp %>%
  filter(!str_detect(occname, coll("supervisor", ignore_case = FALSE))) %>%
  group_by(soc, occp, occname, cow, cowf) %>%
  summarise(n=n(), wtdn=sum(pwgtp), 
            across(c(ltassoc, assoc, ba, maplus), ~ first(.x)), 
            rppwagp=wtd.mean(rppwagp, weights = pwgtp)) %>%
  # filter(n >= 50) %>%
  arrange(-rppwagp)
         
```

<!-- ### Econometric models of correctional officers' wages vs. comparison groups in California -->

```{r}
# bring in occupation injury rate
glimpse(caworkers)
count(caworkers, cow, cowf)
# 1	Private, for profit	532326		
# 2	Private, not for profit	58365		
# 3	Local government	68291		
# 4	State government	35840		
# 5	Federal government	23766	
# ownership_code	ownership_name
# 0	All ownerships
# 1	Private industry
# 7	State government
# 8	Local government
wpirates2 <- wpirates %>%
  mutate(own=as.integer(own),
         ownf=factor(own,
                     levels=c(0, 1, 7, 8, 9),
                     labels=c("All", "Private", "State government", "Local government", "SLG combined")),
         cow=case_when(own==1 ~ 1L,
                       own==7 ~ 4L,
                       own==8 ~ 3L, 
                       TRUE ~ NA_integer_),
         soc=paste0(str_sub(ocode, 1, 2),
                                "-",
                                str_sub(ocode, 3, 6))) %>%
  filter(!is.na(cow))


# 9	State and local government combined

tmp <- wpirates %>%
              filter(stabbr=="US") %>%
              mutate(soc=paste0(str_sub(ocode, 1, 2),
                                "-",
                                str_sub(ocode, 3, 6))) %>%
              select(year, stabbr, soc, wpirate=value)


caworkers_wfi <- caworkers %>%
  left_join(wpirates %>%
              filter(stabbr=="US") %>%
              mutate(soc=paste0(str_sub(ocode, 1, 2),
                                "-",
                                str_sub(ocode, 3, 6))) %>%
              select(year, soc, wpirate=value),
            by = c("year", "soc")) %>%
  mutate(caco=ifelse(cow==4 & soc=="33-3012", TRUE, FALSE))

summary(caworkers_wfi)
caworkers_wfi %>%
  filter(is.na(wpirate)) %>%
  filter(str_sub(soc, 1, 2)=="33") %>%
  count(soc, occname) %>%
  arrange(desc(n))

```

<!-- #### Models comparing state correctional officers to other correctional officers -->

```{r include=FALSE, rows.print=25}
df <- caworkers_wfi %>%
  filter(soc=="33-3012")

camod1 <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) + cowf,
               data=df)

camod1 <- feols(lrppwagp ~ wpirate + exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) + cowf,
               data=df %>% filter(!is.na(wpirate)))

camod1 <- feols(lrppwagp ~ wpirate + exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) + caco,
               data=df %>% filter(!is.na(wpirate)))

camod1 <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) + caco,
               data=df)

camod1 <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) + caco,
               data=df)

camod1 <- feols(lrwagp ~ exp + exp2 + edattain + sex + caco,
               data=df)

summary(camod1)

cafe1 <- fixef(camod1)
# summary(fe)

cfe <- tibble(stabbr=names(fe$stabbr2), fe=fe$stabbr2) %>%
  mutate(cfe=fe - mean(fe),
         stname=get_stname(stabbr),
         stname=ifelse(stabbr=="other", "-- other states as a group", stname))

```

<!-- #### Models comparing correctional officers to jobs in the same occupational cluster -->

```{r include=FALSE, rows.print=25}

df <- caworkers_wfi %>%
  filter(soc %in% job_cluster$occ)

camod1 <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) + cowf,
               data=df)

camod1 <- feols(lrppwagp ~ wpirate + exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) + cowf,
               data=df %>% filter(!is.na(wpirate)))

camod1 <- feols(lrppwagp ~ wpirate + exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) + caco,
               data=df %>% filter(!is.na(wpirate)))

camod1 <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) + caco,
               data=df)

camod1 <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) + caco,
               data=df)

camod1 <- feols(lrwagp ~ exp + exp2 + edattain + sex + caco,
               data=df)

summary(camod1)

cafe1 <- fixef(camod1)
# summary(fe)

cfe <- tibble(stabbr=names(fe$stabbr2), fe=fe$stabbr2) %>%
  mutate(cfe=fe - mean(fe),
         stname=get_stname(stabbr),
         stname=ifelse(stabbr=="other", "-- other states as a group", stname))


#### Models comparing correctional officers to jobs where workers have similar education
```

```{r acs_ca_model, rows.print=25}
glimpse(caworkers)

coed <- cajobeduc %>% 
  filter(soc=="33-3012", cow==4)
coltassoc <- coed$ltassoc

diff <- .05
hsj <- cajobeduc %>%
  # filter(ltassoc >= .6, ltassoc <= .7, wtdn >= 5000)
  filter(ltassoc >= (coltassoc - diff), ltassoc <= (coltassoc + diff), wtdn >= 1000)

# mod1 <- feols(lwage ~ edattain + sex + exp + exp2 + marstat | soc, data=caworkers)
# summary(mod1)
df <- caworkers_wfi %>%
  filter(soc %in% hsj$soc)

# regdf <- caworkers %>% 
#   filter(soc %in% hsj$soc)
# count(regdf, edattain)
# count(regdf, sex)
# count(regdf, marstat)

# mod2 <- feols(lrwagp ~ edattain + exp + exp2 + sex + marstat + rachisp | soc, data=regdf)
# mod2 <- feols(lrppwagp ~ edattain + exp + exp2 + sex + marstat + rachisp + year | soc, data=df)
mod2 <- feols(lrppwagp ~ wpirate + edattain + exp + exp2 + sex + marstat + rachisp + as.factor(year) + caco , data=df)

mod2 <- feols(lrppwagp ~ wpirate + edattain + exp + exp2 + sex + marstat + rachisp +
                as.factor(year) + caco | as.factor(msacode), data=df)

# mod2 <- feols(lwage ~ edattain + exp + exp2 + female + married - 1 | soc, data=regdf)
summary(mod2)  # default clusters on soc
# summary(mod2, cluster= ~ soc)

# tmp <- feols(lwage ~ edattain + sex + exp + exp2 + marstat -1 | soc, data=regdf, demeaned = TRUE)
# fixef(tmp)

# fe <- fixef(mod1)
fe <- fixef(mod2)
fe
# summary(fe)
# fe$soc["33-3012"]
# p <- plot(fe)
# p
# str(p)

cfe <- tibble(soc=names(fe$soc), fe=fe$soc) %>%
  left_join(ocodes, by="soc") %>%
  mutate(cfe=fe - mean(fe)) %>% # centered fixed effects
  arrange(-cfe) %>%
  mutate(rank=row_number())
cfe

cfe %>% filter(soc=="33-3012")

# repeat with msa fixed effects
mod3 <- feols(lrwagp ~ edattain + exp + exp2 + sex + marstat + rachisp | soc + as.factor(msacode), data=regdf)
# mod2 <- feols(lwage ~ edattain + exp + exp2 + female + married - 1 | soc, data=regdf)
summary(mod3)  # default clusters on soc
# summary(mod2, cluster= ~ soc)

# tmp <- feols(lwage ~ edattain + sex + exp + exp2 + marstat -1 | soc, data=regdf, demeaned = TRUE)
# fixef(tmp)

# fe <- fixef(mod1)
fe3 <- fixef(mod3)
fe3
plot(fe3)
# summary(fe)
# fe$soc["33-3012"]
# p <- plot(fe)
# p
# str(p)

cfe3 <- tibble(soc=names(fe3$soc), fe=fe3$soc) %>%
  left_join(ocodes, by="soc") %>%
  mutate(cfe=fe - mean(fe)) %>% # centered fixed effects
  arrange(-cfe) %>%
  mutate(rank=row_number())
cfe3




```


## Within-California comparisons: Workers with similar education
```{r mod_caworkered}
caworkers_ed <- caworkers %>%
  filter(casco | ((soc != "33-3012") & (level=="private"))) %>%
  filter(edattain %in% c("HSgrad", "HSplus", "associate")) %>%
  mutate(edattain=fct_drop(edattain))
summary(caworkers_ed)
nrow(caworkers_ed)

# which of the next 2 formulations is better?
moddum_caworkered <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) + casco,
               data=caworkers_ed)

moddum_caworkered <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp +
                             as.factor(year) + yoschool_wmean + casco,
               data=caworkers_ed)
# , weights = caworkers_ed$pwgtp
# moddum_caworkered$collin.var

summary(moddum_caworkered)

(casco_caworkered <- casco_pct(moddum_caworkered))

```




## Within-California comparisons: Similar education

Here we compare California *state* correctional officers' wages, adjusted for regional cost of living, with wages of California *private sector* workers in occupations where the percentage of workers with less than an associate's degree is within +/- 5 percentage points of the percentage for state correctional officers (therefore, we compare to occupations where roughly 68-78 percent of the workers have less than an associate's degree).

I have collapsed occupations with fewer than 50 workers into an all-other group.

```{r mod_ed_data}
# include state cos and private with similar ed
jobs_ed_base <- caworkers %>%
  filter(casco | ((soc != "33-3012") & (level=="private"))) %>%
  group_by(soc, occname) %>%
  mutate(n=n(),
         occgroup=ifelse(n >= obs_cutoff, occname, "lowobs"),
         soc=ifelse(n >= obs_cutoff, soc, "--")) %>%
  ungroup

jobs_ed <- jobs_ed_base %>%
  group_by(soc, occgroup, casco) %>% # keep casco in the resulting data
  summarise(n=n(),
            wtdn=sum(pwgtp),
            ltassoc=wtd.mean(ltassoc, weights = pwgtp),
            ltba=wtd.mean(ltba, weights = pwgtp),
            ltma=wtd.mean(ltma, weights = pwgtp),
            rwagp=wtd.mean(rwagp, weights = pwgtp),
            .groups="drop")

(casco_ltassoc <- jobs_ed %>% filter(casco) %>% .$ltassoc)
(casco_ltba <- jobs_ed %>% filter(casco) %>% .$ltba)

# range <- .05
# joblist_ed <- jobs_ed %>%
#   filter(occgroup != "lowobs",
#          ltassoc >= (casco_ltassoc - range),
#          ltassoc <= (casco_ltassoc + range))
# sum(joblist_ed$n)

range <- .5
joblist_ed <- jobs_ed %>%
  filter(occgroup != "lowobs",
         ltba >= (casco_ltba - range),
         ltba <= (casco_ltba + range))
summary(joblist_ed)
sum(joblist_ed$n)

caworkers_jobed <- jobs_ed_base %>%
  filter(edattain %in% c("HSgrad", "HSplus", "associate"))  %>%
  # filter(edattain %in% c("HSplus", "associate")) %>%
  # filter(edattain=="HSplus") %>% 
  filter(soc %in% joblist_ed$soc)
nrow(caworkers_jobed)
  
summary(caworkers_jobed)

moddum_cajobed <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) + casco,
               data=caworkers_jobed)
summary(moddum_cajobed)

(casco_cajobed <- casco_pct(moddum_cajobed))

```


```{r mod_jobed}

mod_cajobed <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) | occgroup,
               data=caworkers_jobed)
summary(mod_cajobed)

fe_cajobed <- fixef(mod_cajobed)

sums_jobed <- caworkers_jobed %>%
  group_by(casco, soc, occgroup) %>%
  summarise(n=n(), wtdn=sum(pwgtp), 
            rwagp=wtd.mean(rwagp, weights = pwgtp),
            rppwagp=wtd.mean(rppwagp, weights=pwgtp),
            .groups="drop")
  

# centered fixed effects
cfe_cajobed <- tibble(occgroup=names(fe_cajobed$occgroup), fe=fe_cajobed$occgroup) %>%
  mutate(cfe=fe - mean(fe),
         cfepct=exp(cfe) -1,
         casco_vsother=(1 + cfepct[occgroup=="Correctional officers and jailers"]) /
           (1 + cfepct) - 1) %>%
  arrange(desc(cfepct))
cfe_cajobed
# compute wtd avg of other

# cfe_cajobed %>%
#   left_join(sums_jobed, by = "occgroup") %>%
#   group_by(casco) %>%
#   summarise(fe=wtd.mean(fe, weights=wtdn),
#             cfe_wtdmean=wtd.mean(cfe, weights=wtdn)) %>%
#   mutate(
#     cfe=fe - mean(fe),
#     cfepct=exp(cfe) -1,
#     casco_vsother=(1 + cfepct[casco]) /
#       (1 + cfepct) - 1,
#     cfepct2=exp(cfe_wtdmean) -1,
#     casco_vsother2=(1 + cfepct2[casco]) /
#       (1 + cfepct2) - 1)
  

moddum_cajobed <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp + as.factor(year) + casco,
               data=caworkers_jobed)
summary(moddum_cajobed)

(casco_cajobed <- casco_pct(moddum_cajobed))

```

