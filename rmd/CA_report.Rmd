---
title: "California Bargaining Unit 6 Compensation Analysis"
author: "Don Boyd"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_notebook:
    df_print: paged
    fig_height: 6
    fig_width: 8
    toc: yes
    toc_depth: 3
    toc_float: true
    number_sections: yes
editor_options:
  chunk_output_type: inline
---


```{r links}
# https://download.bls.gov/pub/time.series/cm/
# NCS: https://download.bls.gov/pub/time.series/nb/
# https://www.pewtrusts.org/~/media/Assets/2014/08/StateEmployeeHealthCareReportSeptemberUpdate.pdf

```


```{r runall, eval=FALSE, echo=FALSE}
# When we want a final report, run the following code selectively "by hand" (interactively)
# -- NEVER using Knit with eval=TRUE
# note <br> breaks line for html output but \n should break for pdf; also could try |

rmdfn <- ".CA_report.rmd" # this file
outfn <- paste0("report_", format(Sys.time(), "%Y-%m-%d"), ".html")
rmarkdown::render(rmdfn, output_format="html_document", output_file=outfn)

# library("RCurl")
# ftpUpload(outfn, "ftp://kffrig:boyd4812@files.000webhost.com/public_html/KFF_RIG_MedicaidCuts_new.html")

# Note may b safest to fully exit RStudio and restart it before running whole thing. Otherwise knitr may get confused
# and include repetitive information in the output html file.

```


```{r setup, include=FALSE, eval=TRUE}
knitr::opts_chunk$set(echo = FALSE, include=FALSE, eval=TRUE, message = FALSE, warning = FALSE)
```


```{r libraries}

library(tidyverse)
options(tibble.print_max = 80, tibble.print_min = 80) # if more than 60 rows, print 60 - enough for states
library(purrr)
library(readxl)
library(haven)
library(RSQLite)

library(Hmisc)

library(kableExtra)
library(gt)
library(knitr)
library(arrow)

library(maps)
# https://cran.r-project.org/web/packages/usmap/vignettes/mapping.html
library(usmap)
library(gridExtra)
library(RcppRoll)
library(ggbreak)
library(patchwork)
library(RColorBrewer)

library(fixest)

library(btools)
library(bdata)
```


```{r locations}
# acsdir <- r"(E:\data\acs\)"
# pumsdir <- paste0(acsdir, "pums/")
# csvdir <- paste0(pumsdir, "csv/")

rppdir <- r"(E:\data\BEA_regional_price_parities\)"

resdir <- r"(E:\data\oesw\oes_research\)"

pumsdir <- r"(E:\data\acs\pums\)"
fnpumscodes <- "ACSPUMS2015_2019CodeLists.xlsx"

sqlitedir <- r"(E:\data\acs\pums\sqlite\)"

acsfn <- "acs2019_5year"
acsdb <- paste0(sqlitedir, acsfn, ".sql3")

```


```{r constants}
# 33-3012	Correctional Officers and Jailers  OES code
# 3802 Correctional officers and jailers 33-3012   # occ code 2018
# NY, MA
# TX, FL
# AZ, NV, OR, WA

compstates <- c("AZ", "NV", "OR", "WA", "TX", "FL", "NY", "MA")

```


```{r load_data}
load(file=here::here("data", "caloes.rdata"), verbose=TRUE)
load(file=here::here("data", "rpp.rdata"), verbose=TRUE) # max year is 2019 for all
glimpse(sarpp)
glimpse(marpp)

```


```{r functions}
get_stname <- function(stabbr){
  sts <- c("US", "DC", state.abb)
  allnames <- c("United States", "District of Columbia", state.name)
  allnames[match(stabbr, sts)]
}

```


# Data prep

## Regional price measures
```{r rpp_info}

# https://apps.bea.gov/regional/downloadzip.cfm
# SARPP.zip is states
# MARPP.zip is metropolitan areas


# https://www.bea.gov/news/2020/real-personal-income-state-and-metropolitan-area-2019
# Regional Price Parities in 2019
# 
# Regional price parities (RPPs) measure the differences in price levels across states and metropolitan areas for a given year and are expressed as a percentage of the overall national price level. The all items RPP covers all consumption goods and services, including housing rents. Areas with high/low RPPs typically correspond to areas with high/low price levels for rents.
# 
# States with the highest RPPs were Hawaii (119.3), California (116.4), and New York (116.3) (table 3).
# States with the lowest RPPs were Mississippi (84.4), Arkansas (84.7), and Alabama (85.8).
# Across states, California had the highest RPP for housing rents (153.6), and Mississippi had the lowest (60.0).
# Large metropolitan areas with the highest RPPs were San Francisco-Oakland-Berkeley, CA (134.5), New York-Newark-Jersey City, NY-NJ-PA (125.7), and Los Angeles-Long Beach-Anaheim, CA (118.8) (table 6).
# Large metropolitan areas with the lowest RPPs were Cleveland-Elyria, OH (89.9), St. Louis, MO-IL (90.1), and Cincinnati, OH-KY-IN (90.6).
# Across large metropolitan areas, San Francisco-Oakland-Berkeley, CA, had the highest RPP for housing rents (200.3), and Cleveland-Elyria, OH, had the lowest (76.3).
# Across all metropolitan areas, San Jose-Sunnyvale-Santa Clara, CA, had the highest RPP for housing rents (224.0), and Beckley, WV, had the lowest (44.0).
```


```{r get_rpp}
# con <- unz(paste0(dir, "/", "SQGDP.zip"), fn) # read directly from zip file
zname <- "SARPP.zip"
fn <- "SARPP_STATE_2008_2019.csv"
con <- unz(paste0(rppdir, zname), fn) # read directly from zip file
df <- read_csv(con, col_types = cols(.default = "c"))

sarpp1 <- df %>%
  filter(LineCode=="1") %>%
  mutate(stfips=str_sub(GeoFIPS, 1, 2)) %>%
  left_join(stcodes %>% select(stfips, stabbr), by = "stfips")
sarpp1 %>% select(stfips, stabbr, GeoName)
  
sarpp <- sarpp1 %>%
  pivot_longer(cols=`2008`:`2019`, names_to = "year", values_to = "rpp") %>%
  mutate(year=as.integer(year), rpp=as.numeric(rpp)) %>%
  select(stabbr, year, rpp)

sarpp %>%
  filter(stabbr %in% c("US", "CA", "NY", "FL", "TX", "MA")) %>%
  ggplot(aes(year, rpp, colour=stabbr)) +
  geom_line() +
  geom_point()

# now get metropolitan indexes
zname <- "MARPP.zip"
fn <- "MARPP_MSA_2008_2019.csv"
con <- unz(paste0(rppdir, zname), fn) # read directly from zip file
df <- read_csv(con, col_types = cols(.default = "c"))
glimpse(df)

marpp <- df %>%
  filter(LineCode=="1") %>%
  pivot_longer(cols=`2008`:`2019`, names_to = "year", values_to = "rpp") %>%
  mutate(year=as.integer(year), rpp=as.numeric(rpp)) %>%
  select(fips=GeoFIPS, geoname=GeoName, year, rpp)

# which ones are in California
carpp <- marpp %>%
  filter(str_detect(geoname, coll("CA")))
count(carpp, fips, geoname)

save(sarpp, marpp, carpp, file=here::here("data", "rpp.rdata"))

# There are 26 Californial regional price indexes
# fips  geoname                                                                  n
#    <chr> <chr>                                                                <int>
#  1 12540 Bakersfield, CA (Metropolitan Statistical Area)                         12
#  2 17020 Chico, CA (Metropolitan Statistical Area)                               12
#  3 20940 El Centro, CA (Metropolitan Statistical Area)                           12
#  4 23420 Fresno, CA (Metropolitan Statistical Area)                              12
#  5 25260 Hanford-Corcoran, CA (Metropolitan Statistical Area)                    12
#  6 31080 Los Angeles-Long Beach-Anaheim, CA (Metropolitan Statistical Area)      12
#  7 31460 Madera, CA (Metropolitan Statistical Area)                              12
#  8 32900 Merced, CA (Metropolitan Statistical Area)                              12
#  9 33700 Modesto, CA (Metropolitan Statistical Area)                             12
# 10 34900 Napa, CA (Metropolitan Statistical Area)                                12
# 11 37100 Oxnard-Thousand Oaks-Ventura, CA (Metropolitan Statistical Area)        12
# 12 39820 Redding, CA (Metropolitan Statistical Area)                             12
# 13 40140 Riverside-San Bernardino-Ontario, CA (Metropolitan Statistical Area)    12
# 14 40900 Sacramento-Roseville-Folsom, CA (Metropolitan Statistical Area)         12
# 15 41500 Salinas, CA (Metropolitan Statistical Area)                             12
# 16 41740 San Diego-Chula Vista-Carlsbad, CA (Metropolitan Statistical Area)      12
# 17 41860 San Francisco-Oakland-Berkeley, CA (Metropolitan Statistical Area)      12
# 18 41940 San Jose-Sunnyvale-Santa Clara, CA (Metropolitan Statistical Area)      12
# 19 42020 San Luis Obispo-Paso Robles, CA (Metropolitan Statistical Area)         12
# 20 42100 Santa Cruz-Watsonville, CA (Metropolitan Statistical Area)              12
# 21 42200 Santa Maria-Santa Barbara, CA (Metropolitan Statistical Area)           12
# 22 42220 Santa Rosa-Petaluma, CA (Metropolitan Statistical Area)                 12
# 23 44700 Stockton, CA (Metropolitan Statistical Area)                            12
# 24 46700 Vallejo, CA (Metropolitan Statistical Area)                             12
# 25 47300 Visalia, CA (Metropolitan Statistical Area)                             12
# 26 49700 Yuba City, CA (Metropolitan Statistical Area)                           12


```


## ACS

```{r connect_acsdb}
dbDisconnect(db) # in case it is connected - will throw an error if not, but that's ok
db <- dbConnect(SQLite(), dbname=acsdb)

```


```{r acs_occ_codes}
ocodes1 <- read_excel(paste0(pumsdir, fnpumscodes),
                      sheet="OCCP & SOCP",
                      range="A11:C881",
                      col_names=c("occp", "soc", "occname"))
ocodes <- ocodes1 %>%
  filter(nchar(occp)==4) %>%
  mutate(occp=as.integer(occp))

```


```{r acs_factors}

#.. COW Character 1 ----
# Class of worker
# b .Not in universe (less than 16 years old/NILF who last worked .more than 5 years ago or never worked)
# 1 .Employee of a private for-profit company or business, or of an .individual, for wages, salary, or commissions
# 2 .Employee of a private not-for-profit, tax-exempt, or .charitable organization
# 3 .Local government employee (city, county, etc.)
# 4 .State government employee
# 5 .Federal government employee
# 6 .Self-employed in own not incorporated business, professional .practice, or farm
# 7 .Self-employed in own incorporated business, professional .practice or farm
# 8 .Working without pay in family business or farm
# 9 .Unemployed and last worked 5 years ago or earlier or never .worked

#.. MAR Character 1 ----
# Marital status
# 1 .Married
# 2 .Widowed
# 3 .Divorced
# 4 .Separated
# 5 .Never married or under 15 years old

#.. RAC1P Character 1 ----
# Recoded detailed race code
# 1 .White alone
# 2 .Black or African American alone
# 3 .American Indian alone
# 4 .Alaska Native alone
# 5 .American Indian and Alaska Native tribes specified; or .American Indian or
# Alaska Native, not specified and no other races
# 6 .Asian alone
# 7 .Native Hawaiian and Other Pacific Islander alone
# 8 .Some Other Race alone
# 9 .Two or More Races

#.. SCHL Character 2 ----
# Educational attainment
# bb .N/A (less than 3 years old)
# 01 .No schooling completed
# 02 .Nursery school, preschool
# 03 .Kindergarten
# 04 .Grade 1
# 05 .Grade 2
# 06 .Grade 3
# 07 .Grade 4
# 08 .Grade 5
# 09 .Grade 6
# 10 .Grade 7
# 11 .Grade 8
# 12 .Grade 9
# 13 .Grade 10
# 14 .Grade 11
# 15 .12th grade - no diploma
# 16 .Regular high school diploma
# 17 .GED or alternative credential
# 18 .Some college, but less than 1 year
# 19 .1 or more years of college credit, no degree
# 20 .Associate's degree
# 21 .Bachelor's degree
# 22 .Master's degree
# 23 .Professional degree beyond a bachelor's degree
# 24 .Doctorate degree

f_yoschool <- function(schl, agep){
  # estimate years of schooling based on educational attainment
  yoschool <- case_when(schl <= 14 ~ 11,  # no higher than 11th grade -- give them 12 years
                      schl %in% 15:17 ~ 12,  # HS diploma or alternative
                      schl %in% 18:19 ~ 13,  # +/- another year
                      schl == 20 ~ 14,  # associate's
                      schl == 21 ~ 16,  # bachelor's
                      schl == 22 ~ 18,  # master's -- 2 years?
                      schl == 23 ~ 19,  # professional degree
                      schl == 24 ~ 20,  # doctorate
                      TRUE ~ NA_real_)
  ifelse(yoschool > agep - 6,
         agep - 6,
         yoschool)
}


f_race_hisp <- function(rac1p, hisp) {
  # hisp==1 is NOT hispanic
  y <- ifelse(hisp==1, rac1p, 0)
  y <- factor(y)
  levels(y) <- list("White alone, not Hispanic"=1, 
                    "Black alone, not Hispanic"=2,
                    "Hispanic, any race"=0,
                    "Asian alone, not Hispanic"=6,
                    "Other or multiple race, not Hispanic"=c(3:5, 7:9))
  return(y)
}

```


```{r acs_vardefs}

acsvars_string <- "serialno, st, adjinc, pwgtp, agep, cow, mar, schl, sex, wagp, hisp, rac1p, occp"

# define the filter definition for a worker so we  have it in only one place
# worker <- expression(wagp >= 10e3, agep >= 18)  # haven't gotten this to work
sworker <- "schl > 15 & wagp >= 10e3 & agep >= 18"  # as a string - works with filter(eval(parse(text=sworker))), albeit awkward

create_vars <- function(df){
  # create multiple new variables for df
  # df has acs variables
  df %>%
    mutate(year=str_sub(serialno, 1, 4) %>% as.integer,
           adjinc=adjinc / 1e6,
           rwagp=wagp * adjinc,
           yoschool=f_yoschool(schl, agep),
           agep2=agep^2,
           exp=agep - yoschool - 6,
           exp2=exp^2,
           lrwagp=log(rwagp),
           sex=factor(sex, levels=1:2, labels=c("male", "female")),
           rachisp=f_race_hisp(rac1p, hisp),
           edattain=case_when(schl <= 15 ~ "notHSgrad",
                            schl %in% 16:19 ~ "HSgrad",
                            schl == 20 ~ "associate",
                            schl == 21 ~ "BA",
                            schl %in% 22:24 ~ "MAplus",
                            TRUE ~ "other"),
           # put edattain values in desired order
           edattain=factor(
             edattain,
             levels=c("HSgrad", "associate", "BA", "MAplus", "notHSgrad", "other")),
           marstat=factor(
             mar,
             levels=1:5,
             labels=c("married", "widowed", "divorced", "separated", "neverM")))
  }

# tmp <- df1 %>% mutate(create_vars(.))


```


```{r acs_corrections_US}
# get all state government corrections officers in the US
corr_sqlcmd <- paste0("SELECT ", acsvars_string, " FROM pus WHERE occp=3802") # 10 secs
system.time(corr_base <- collect(tbl(db, sql(corr_sqlcmd))))  # 3 secs
glimpse(corr_base) # 21,989 obs
count(corr_base, st)

corr_workers <- corr_base %>%
  filter(eval(parse(text=sworker))) %>% 
  filter(cow == 4) %>%  # state government
  left_join(stcodes %>% 
              select(st=stfips, stabbr) %>% 
              mutate(st=as.integer(st)),
            by="st") %>%
  left_join(sarpp %>% filter(year==2017) %>% 
              select(stabbr, rpp) %>%
              mutate(rpp=rpp / 100),
            by="stabbr") %>%
  mutate(create_vars(.),
         rppwagp=rwagp / rpp,  # rwagp is real wage (adjusted for year), rppwagp is region adjusted
         lrppwagp=log(rppwagp)) %>%  
  group_by(stabbr) %>%
  mutate(n=n()) %>%
  ungroup

summary(corr_workers)

```


## ACS descriptive statistics of correction worker wages across states
```{r}
corr_cut <- 50

glimpse(corr_workers)
corr_workers <- corr_workers %>%
  mutate(stabbr2=ifelse(n >= corr_cut, stabbr, "other")) 
count(corr_workers, edattain)
count(corr_workers, stabbr2) # 39 states


corr_wages <- corr_workers %>%
  group_by(stabbr2) %>%
  summarise(n=n(),
            wtdn=sum(pwgtp),
            rwagp=wtd.mean(rwagp, weights=pwgtp),
            rppwagp=wtd.mean(rppwagp, weights=pwgtp),
            exp=wtd.mean(exp, weights=pwgtp))

corr_ed <- corr_workers %>%
  group_by(stabbr2, edattain) %>%
  summarise(wtdn=sum(pwgtp), .groups="drop") %>%
  group_by(stabbr2) %>%
  mutate(share=wtdn / sum(wtdn)) %>%
  select(stabbr2, edattain, share) %>%
  pivot_wider(names_from = edattain, values_from = share, values_fill = 0) %>%
  mutate(lehs=notHSgrad + HSgrad)

corr_sex <- corr_workers %>%
  group_by(stabbr2, sex) %>%
  summarise(wtdn=sum(pwgtp), .groups="drop") %>%
  group_by(stabbr2) %>%
  mutate(share=wtdn / sum(wtdn)) %>%
  select(stabbr2, sex, share) %>%
  pivot_wider(names_from = sex, values_from = share, values_fill = 0)

corr_summary <- corr_wages %>%
  left_join(corr_ed, by="stabbr2") %>%
  left_join(corr_sex %>% select(stabbr2, male), by="stabbr2") %>%
  mutate(stname=get_stname(stabbr2)) %>%
  select(stabbr2, stname, n, wtdn, exp, rwagp, rppwagp, male, lehs) %>%
  arrange(stname)
```


```{r}

corr_summary
corr_summary %>%
  arrange(desc(lehs))

corr_summary %>%
  arrange(desc(rwagp))

corr_summary %>%
  arrange(desc(rppwagp))

corr_summary %>%
  ggplot(aes(male, rwagp, label=stabbr2)) +
  geom_point(colour="blue", size=1) +
  geom_text(colour="blue", size=3) +
  theme_bw()


corr_summary %>%
  ggplot(aes(lehs, rppwagp, label=stabbr2)) +
  geom_point(colour="blue", size=1) +
  geom_text(colour="blue", size=3) +
  geom_vline(xintercept = median(corr_summary$lehs)) +
  theme_bw()

corr_summary %>%
  ggplot(aes(lehs, rwagp, label=stabbr2)) +
  geom_point(colour="blue", size=1) +
  geom_text(colour="blue", size=3) +
  theme_bw()

corr_summary %>%
  ggplot(aes(exp, rppwagp, label=stabbr2)) +
  geom_point(colour="blue", size=1) +
  geom_text(colour="blue", size=3) +
  theme_bw()

```



## ACS models of correction worker wages across states
```{r acs_corr_models, include=TRUE, fig.height=8, fig.width=10}
# https://cran.r-project.org/web/packages/fixest/fixest.pdf
# https://cran.r-project.org/web/packages/fixest/vignettes/fixest_walkthrough.html

# count(corr_workers, edattain)
# count(corr_workers %>% filter(stabbr=="CA"), edattain)
# count(corr_workers, stabbr2, stabbr)
femod <- feols(lrppwagp ~ exp + exp2 + edattain + marstat + sex + rachisp | stabbr2,
               data=corr_workers, notes=FALSE)
# suppress note about dropping edattainother
summary(femod)

# check the wage-experience profile for reasonableness
# tibble(exp=0:40, exp2=exp^2, e1=exp * coef(femod)["exp"], e2=exp2 * coef(femod)["exp2"]) %>%
#   mutate(earn=e1 + e2) %>%
#   ggplot(aes(exp, earn)) +
#   geom_line() +
#   labs(x="Experience (years)", y="Log earnings") +
#   ggtitle("Estimated U.S. average earnings-experience profile for correctional officers") +
#   theme_bw()

fe <- fixef(femod)
# summary(fe)

cfe <- tibble(stabbr=names(fe$stabbr2), fe=fe$stabbr2) %>%
  mutate(cfe=fe - mean(fe),
         stname=get_stname(stabbr),
         stname=ifelse(stabbr=="other", "-- other states as a group", stname))

gtitle <- "State correctional officer salaries relative to those in the average state"
gsubtitle <- "Adjusted for state price levels, and controlling for experience, education, and demographic characteristics"
capt1 <- "Source: Author's analysis of U.S. Bureau of the Census, American Community Survey, 2015-2019"
capt2 <- "Note: States with fewer than 50 observations were grouped togther."
capt <- paste0(capt1, "\n", capt2)
statefe_dots <- cfe %>%
  # filter(stabbr != "Other") %>%
  mutate(grp=ifelse(stabbr=="CA", "CA", "other")) %>%
  ggplot(aes(y=reorder(stname, cfe), x=cfe * 100)) +
  geom_point(aes(colour=grp), size=2) +
  scale_colour_manual(values=c("red", "blue")) +
  theme_minimal() +
  labs(x="% above or below average state", y=NULL,
       caption=capt) +
  ggtitle(label=gtitle, subtitle = gsubtitle) +
  theme(axis.text.y = element_text(hjust = 0)) +
  geom_vline(xintercept = 0) +
  scale_x_continuous(breaks=seq(-100, 100, 5)) +
  theme(legend.position = "none") +
  theme(plot.caption = element_text(hjust = 0))

statefe_dots

ggsave(here::here("results", "statefe_dots.png"), 
       plot=statefe_dots, width=10, height=8, scale=1.25)
  
```



# Comparisons to Corrections Officers in Other States

## OES data

```{r oes_notes}
# https://www.bls.gov/oes/oes_con.htm
# Two types of OEWS estimates can be downloaded directly from this website in Excel (XLS) format:
# 
# Occupational employment and wage estimates by geographic area (national, state, metropolitan, and nonmetropolitan area)
# National Occupational employment and wage estimates by industry (sector, 3-, 4-, and selected 5- and 6-digit North American Industry Classification System levels)
# Download Occupational Employment and Wage Estimates
# 
# In addition to the estimates that can be downloaded directly from this website, historical OEWS estimates are available upon request through the contact information above. Historical OEWS estimates consist of the 1988 to 1995 national occupational employment and wage data by industry, for most industries at the 2- and 3-digit Standard Industrial Classification (SIC) levels. Estimates for 1988 - 1995 contain only employment data. Between 1988 and 1995 covered industries were surveyed once in a three-year cycle. The OEWS program now surveys all covered industries each year.
# 
# Note: 1996 estimates are not available.
# 
# OEWS State Employment and Wage Estimates
# Occupational Employment and Wage Statistics estimates, by occupation and by industry, for individual states are available from the states' Labor Market Information (LMI) or Research, Analysis, and Statistics offices which are part of their State Employment Security Agencies (SESAs). Availability, format and medium of the data varies by state. To obtain OEWS estimates for a particular state, please contact the appropriate office on the State Contact List.
```

```{r}
# main oes data
# Hi, I'm looking for OES data for states, and possible metro areas, ideally in a single file. I have found the year-by-year state Excel files (https://www.bls.gov/oes/tables.htm) which are awkward to work with but not a bad last resort, and I have found the link for the new OEWS-titled data (https://download.bls.gov/pub/time.series/oe/) but that is only for the latest release. I was hoping you have the historical data in a single csv or flat ASCII file, for all years and states (and maybe metro areas). Would you have a link to a download site for these data? Many thanks in advance. Don Boyd

```

```{r bls_research}
#.. BLS state research estimates ----
# https://www.bls.gov/oes/current/oes_research_estimates.htm
# The OEWS program provides wage and employment estimates by state and industry
# beginning with the May 2012 reference period. These estimates are intended for
# research purposes, and users should be aware of the limitations of the data.
# Estimates prior to May 2012 are not available. Estimates are only available
# for states; industry-specific estimates for metropolitan areas are not
# available. Estimates are only available for detail and major occupation
# groups; industry-specific estimates for broad and minor occupation groups are
# not available.
oes <- readRDS(paste0(resdir, "oesres_sec99.rds"))
glimpse(oes)
count(oes, own_code, o_group)
count(oes, naics_title)

# get 1st-line supervisors and corrections officers
# 33-1011	First-Line Supervisors of Correctional Officers	High school diploma or equivalent
# 33-3012	Correctional Officers and Jailers	High school diploma or equivalent
corr <- oes %>%
  filter(occ %in% c("33-1011", "33-3012"),
         !str_detect(naics_title, "Federal")) %>%
  mutate(level=case_when(str_detect(naics_title, "State") ~ "state",
                         str_detect(naics_title, "Local") ~ "local",
                         TRUE ~ "ERROR"))
count(corr, level, own_code, o_group)
count(corr, naics_title)
count(corr, year, level) %>% pivot_wider(names_from = level, values_from = n)
corr %>% filter(stabbr=="CA", year==2012)
corr %>% filter(is.na(stabbr))
count(corr, stabbr)
summary(corr)  # annual has no data

corr2 <- corr %>%
  filter(stabbr %in% state.abb) %>%
  select(year, occ, occname, stabbr, area=area_title, level, emp=tot_emp, awage=a_mean, awage_mdn=a_median)

corr2 %>% filter(stabbr=="CA")


```

### Graphs and tables of OES research

```{r}

corr2 %>%
  filter(year==2020) %>%
  select(year, occ, occname, stabbr, level, awage) %>%
  pivot_wider(names_from = level, values_from = awage) %>%
  group_by(occ) %>%
  mutate(across(c(state, local), list(rank = ~ rank(-.x)))) %>%
  ungroup %>%
  arrange(occ, state_rank)

cols <- c('#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6')
cols <- c('#a6cee3','#1f78b4','black','#33a02c','#fb9a99','#e31a1c','#fdbf6f','#ff7f00','#cab2d6')

p <- corr2 %>%
  filter(occ=="33-3012", stabbr %in% compstates, level=="state") %>%
  mutate(cadum=ifelse(stabbr=="CA", 1, 0) %>% as.factor) %>%
  arrange(desc(cadum), area) %>%
  ggplot(aes(year, awage / 1000, colour=area)) +
  geom_line(size=1.0) +
  geom_point() +
  scale_colour_manual(values=cols) +
  # scale_size_manual(values=c(1, rep(.5, 8))) +
  labs(y="Average annual wage ($thousands)", x=NULL,
       caption="Source: U.S. Bureau of Labor Statistics, Occupational Employment and Wage Statistics") +
  scale_y_continuous(breaks=seq(0, 200, 10), labels = scales::dollar, limits=c(0, NA)) +
  ggtitle("Average annual salaries of state correctional officers",
          subtitle="California, neighbors, and selected other states") +
  theme_bw() +
  theme(legend.title = element_blank(),
        plot.caption = element_text(hjust = 0))
p
ggsave(here::here("results", "oes_wages.png"), plot = p,
       width=10, height=8, scale=1)


```

## Intra-California

```{r}
load(file=here::here("data", "caloes.rdata"), verbose=TRUE)  # just California
glimpse(cal_oes)
count(cal_oes, atype)
count(cal_oes , aname)

```

## Education requirements

```{r}
# https://www.bls.gov/oes/additional.htm
# The typical education level required to enter an occupation is based on education and training categories from the BLS Employment Projections program. Because of changes to the occupational classification system that began with the May 2019 OEWS estimates and because the entry-level educational requirements assigned to some occupations have changed, the May 2020 OEWS data by typical-entry level educational requirement are not directly comparable to OEWS typical entry-level education data prior to 2019. The May 2020 estimates are based primarily on the system of education and training requirements used for the 2018-2028 employment projections.

# https://www.bls.gov/oes/2020/may/education_2020.xlsx
# 33-1011	First-Line Supervisors of Correctional Officers	High school diploma or equivalent
# 33-3012	Correctional Officers and Jailers	High school diploma or equivalent

# ONETIME
# ujobed <- "https://www.bls.gov/oes/2020/may/education_2020.xlsx"
# download.file(url=ujobed, destfile=here::here("data_raw", "education_2020.xlsx"), mode="wb")
# END ONETIME

jobed1 <- read_excel(here::here("data_raw", "education_2020.xlsx"), sheet = "educ_list", skip=3)
jobed <- jobed1 %>%
  setNames(c("occ", "occname", "entryed"))
count(jobed, entryed)
jobed %>%
  filter(str_sub(occ, 1, 2)=="33")

# get 2020 records in CA for HS jobs
# hsjobs <- jobed %>%
#   filter(entryed=="High school diploma or equivalent")
# 
# oeshs1 <- readRDS(paste0(resdir, "oesres_allsectors.rds")) %>%
#   filter(stabbr=="CA", year==2020, occ %in% hsjobs$occ)
# 
# oeshs2 <- oeshs1 %>%
#   filter(tot_emp >= 1000, i_group=="sector") %>%
#   select(stabbr, year, occ, occname, naics, naics_title, i_group, tot_emp, h_mean, a_mean) %>%
#   arrange(-a_mean)
# 
# 
# oeshs3 <- oeshs1 %>%
#   filter(tot_emp >= 10000, i_group=="sector", 
#          !str_detect(occname, coll("supervisor", ignore_case = TRUE))) %>%
#   select(stabbr, year, occ, occname, naics, naics_title, i_group, tot_emp, h_mean, a_mean) %>%
#   arrange(-a_mean)
# 
# # collapse by occupation ----
# oeshs_mean <- oeshs2 %>%
#   filter(i_group=="sector", 
#          !str_detect(occname, coll("supervisor", ignore_case = TRUE))) %>%
#   mutate(totwage=tot_emp * a_mean) %>%
#   group_by(stabbr, year, occ, occname) %>%
#   summarise(tot_emp=sum(tot_emp), totwage=sum(totwage), .groups = "drop") %>%
#   mutate(awage=totwage / tot_emp) %>%
#   arrange(-awage)
# summary(oeshs_mean)
# 
# tabdata <- oeshs_mean %>%
#   filter(tot_emp >= 10000) %>%
#   arrange(-awage) %>%
#   mutate(rank=row_number()) %>%
#   select(rank, occ, occname, tot_emp, awage)

# alternative approach to tabdata
tabbase <- 
  readRDS(paste0(resdir, "oesres_allsectors.rds")) %>%
  filter(stabbr=="CA", year==2020) %>%# my alternative
  filter(i_group=="sector", !is.na(a_mean), !is.na(tot_emp)) %>% # djb verify this
  select(stabbr, year, occ, occname, naics, naics_title, i_group, tot_emp, h_mean, a_mean) %>%
  # collapse by occupation
  filter(i_group=="sector") %>%
  # filter(!str_detect(occname, coll("supervisor", ignore_case = TRUE))) %>%
  mutate(totwage=tot_emp * a_mean) %>%
  group_by(stabbr, year, occ, occname) %>%
  summarise(tot_emp=sum(tot_emp), totwage=sum(totwage), .groups = "drop") %>%
  mutate(awage=totwage / tot_emp)


# get top 20 jobs by employment plus all other
pct_leHS <- 70
ncats <- 40
minemp <- 5000
# 	53-7062
tabdata <- tabbase %>%
  left_join(hscodes %>%
              select(occ=occ2, pct), by="occ") %>%
  filter(pct >= pct_leHS) %>%
  arrange(desc(tot_emp)) %>%
  mutate(erank=row_number(),
         # pick one or the other of the following
         keep=ifelse(erank <= ncats, TRUE, FALSE),
         # keep=ifelse(tot_emp >= minemp, TRUE, FALSE),
         # now use it
         egroup=ifelse(keep, erank, 999),
         occ=ifelse(keep, occ, ""),
         occname=ifelse(keep, occname, "  All other")) %>%
  group_by(keep, stabbr, year, occ, occname) %>%
  summarise(tot_emp=sum(tot_emp), totwage=sum(totwage), .groups = "drop") %>%
  mutate(awage=totwage / tot_emp,
         premium=awage[occ=="33-3012"] / awage - 1) %>%
  arrange(desc(keep), -awage) %>%
  mutate(rank=ifelse(keep, row_number(), NA_real_)) %>%
  select(rank, occ, occname, tot_emp, awage, premium)
tabdata

count(tabdata, keep)

tab <- tabdata %>%
  gt() %>%
  tab_header(
    title = "Occupations in California where typical entry education requirement is a high school diploma",
      subtitle = "Public and/or private sector occupations with at least 10,000 employees"
      ) %>%
  cols_label(rank="Rank",
             occ=md("Code"),
             occname=md("Occupation"),
             tot_emp=md("Employment  
                        in 2020"),
             awage=md("Average wage  
                      in 2020")) %>%
  # tab_spanner(
  #   label = "Rate adjustment:",
  #   columns = c(actual, adjust)
  #   ) %>%
  fmt_number(
    columns = c(tot_emp),
    decimals = 0) %>%
  fmt_currency(
    columns = c(awage),
    decimals = 0) %>%
  tab_style(
    style = list(
      cell_fill(color = "lightgrey")
      ),
    locations = cells_body(
      rows=c(1)
      )
    ) %>%
  tab_source_note("Source: Bureau of Labor Statistics Occupational Employment and Wage Statistics, Research Database.")
  # tab_footnote(
  #   footnote = "Source: Bureau of Labor Statistics Occupational Employment and Wage Statistics, Research Database.",
  #   locations = cells_title(groups = "title")
  #   )

tab
# gtsave(tab, filename="hspay.png", path=here::here("results"))
gtsave(tab, filename="hspay_v2.html", path=here::here("results"))


# Most criminal investigators and detectives earn an associate degree in criminal justice or law enforcement, and some earn a bachelor's degree. Most graduate from a police training academy and work as police officers to gain law enforcement experience. A promotion is often required to become a criminal investigator.

#djb: While BLS says that Detectives and Criminal Investigators (the highest paying HS job on the list) typically need a HS diploma for entry, CalHR (https://www.calhr.ca.gov/state-hr-professionals/pages/8610.aspx) says all levels of the criminal investigator series need to have the equivalent of at least 2 years of college. 


# California Correctional Officer requirements
# https://www.cdcr.ca.gov/por/minimum-qualifications-2/minimum-qualifications/
# Graduation from a U.S. high school, G.E.D. or equivalent from a U.S. institution, or a California High School Proficiency Examination (CHSPE) certificate is required, or possession of a college degree (Associate of Arts or higher) from an accredited college or university.

#.. CalHR job requirements ----
# Correctional officer
# https://www.calhr.ca.gov/state-hr-professionals/Pages/9662.aspx
# Education: Equivalent to completion of the twelfth grade.

# Investigator Series
# https://www.calhr.ca.gov/state-hr-professionals/pages/8610.aspx
# Education requirements are more stringent but it is possible to substitute experience for education.
# For example, one of the education requirements is:
# Education: Equivalent to completion of two years of college with a major in criminal justice, law enforcement, criminology, administration of justice, police science, or a comparable field of study. (Additional qualifying experience may be substituted for the required education on a year-for-year basis. Applicants who are being considered for Investigator positions assigned as Peace Officer status (as defined by California state law) must possess the educational equivalent to completion of the twelfth grade.) and


# BLS ----
# https://www.onetonline.org/link/summary/33-3051.00  Police and detectives etc...
# Job Zone: Education	Most occupations in this zone require training in vocational schools, related on-the-job experience, or an associate's degree.

# https://www.onetonline.org/link/summary/33-3012.00 Correctional officer
# Education	These occupations usually require a high school diploma.

# https://www.onetonline.org/link/summary/11-3071.00 Transportation, Storage, and Distribution Managers
# Education	Most of these occupations require a four-year bachelor's degree, but some do not.


```

### Education data development
```{r}
# find jobs with similar education requirements to corrections officers
edir <- r"(E:\data\CA_BU6_project\db_26_0_excel\)"
fnecats <- "Education, Training, and Experience Categories.xlsx"
fneoccs <- "Education, Training, and Experience.xlsx"

ecats1 <- read_excel(paste0(edir, fnecats), sheet=1)
eoccs1 <- read_excel(paste0(edir, fneoccs), sheet=1)

catnames <- c("elid", "elname", "scaleid", "scalename", "cat", "catdesc")
ecats <- ecats1 %>%
  setNames(catnames)

ednames <- c("occ", "occname", "elid", "elname", "scaleid", "scalename", "cat", "pct",
             "n", "se", "lci", "uci", "recsuppress", "date", "domain")
eoccs <- eoccs1 %>%
  setNames(ednames)

#.. edoccs 33-3012.00 ----
# create factors for education
edcodes <- ecats %>%
  filter(scaleid=="RL") %>%
  # create short labels
  mutate(catlabel=case_when(cat == 3 ~ "Post-Secondary Certificate",
                            cat == 7 ~ "Post-Baccalaureate Certificate",
                            cat == 9 ~ "Post-Master's Certificate",
                            cat == 10 ~ "First Professional Degree",
                            TRUE ~      catdesc))

edoccs <- eoccs %>%
  filter(scaleid=="RL") %>%
  select(occ, occname, cat, pct, recsuppress, n) %>%
  left_join(edcodes %>% select(cat, catlabel), by="cat")

# hsjobs <- edoccs %>%
#   filter(cat==2, pct>=80)
# hsjobs %>% 
#   arrange(desc(pct))

# hscodes <- edoccs %>%
#   filter(cat==2, pct>=70) %>%
#   mutate(occ2=str_sub(occ, 1, 7)) %>%
#   .$occ2

hscodes <- edoccs %>%
  filter(cat %in% c(1, 2)) %>%
  group_by(occ, occname) %>%
  summarise(pct=sum(pct), n=sum(n), .groups = "drop") %>%
  mutate(occ2=str_sub(occ, 1, 7)) %>%
  arrange(desc(pct))

hscodes %>% filter(str_detect(occ, "53-7062")) # djb figure this out!!
# also this
# 1-3031.01
# Treasurers and Controllers
# 0.00
# 50
# 11-3031
# 10
# 11-3031.03
# Investment Fund Managers
# 0.00
# 50
# 11-3031
  
hscodes %>% filter(str_detect(occname, "Correction"))  
  
  
  


```





# Ideas

-   Top private sector occs with hs grad in CA vs corrections in CA
-   Top publics us vs ca, comp to bu6 differential

# Descriptive statistics from Cal OES

```{r}
count(cal_oes, wtype)
count(cal_oes, atype)


base <- 2009
dflong <- cal_oes %>%
  filter(soc=="333012", wtype=="annual", atype=="state") %>%
  pivot_longer(cols=wage:wp90) %>%
  group_by(name) %>%
  mutate(ivalue=value / value[year==base] * 100 - 100,
         cagr2009=(value / value[year==2009])^(1 / (year - 2009)) * 100 - 100,
         cagr2012=(value / value[year==2012])^(1 / (year - 2012)) * 100 - 100,
         cagr2016=(value / value[year==2016])^(1 / (year - 2016)) * 100 - 100)


cal_oes %>%
  filter(soc=="333012", wtype=="annual", atype=="state") %>%
  ggplot(aes(year, wage)) +
  geom_line() +
  geom_point()

dflong %>%
  ggplot(aes(year, ivalue, colour=name)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(breaks=seq(-50, 50, 5)) +
  geom_hline(yintercept = 0)

dflong %>%
  ggplot(aes(year, cagr2016, colour=name)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(breaks=seq(-50, 50, 0.5)) +
  geom_hline(yintercept = 0)

dflong %>%
  filter(year >= 2012) %>%
  ggplot(aes(year, cagr2012, colour=name)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(breaks=seq(-50, 50, 0.5)) +
  geom_hline(yintercept = 0)


```

# Descriptive statistics from the ACS



```{r get_corrections}

```


## Examine California with ACS
```{r}
vars <- "serialno, st, adjinc, pwgtp, agep, cow, mar, schl, sex, wagp, hisp, rac1p, occp"
sqlcmd <- paste0("SELECT ", vars, " FROM pus WHERE st=06") # 10 secs

system.time(cadf <- collect(tbl(db, sql(sqlcmd))))  # 4 secs
glimpse(cadf)
count(cadf, st) # 1.9m

# cadf %>% 
#   mutate(year=str_sub(serialno, 1, 4)) %>% 
#   group_by(year) %>%
#   summarise(minadjinc=min(adjinc), maxadjinc=max(adjinc))
#   year  minadjinc maxadjinc
#   <chr>     <int>     <int>
# 1 2015    1080470   1080470
# 2 2016    1073449   1073449
# 3 2017    1054606   1054606
# 4 2018    1031452   1031452
# 5 2019    1010145   1010145

caworkers <- cadf %>%
  filter(wagp > 0, agep >= 18, cow %in% 1:5) %>%
  left_join(ocodes, by="occp") %>%
  mutate(year=str_sub(serialno, 1, 4),
         adjinc=adjinc / 1e6,
         yoschool=f_yoschool(schl),
         yoschool=ifelse(yoschool > agep - 6,
                         agep - 6,
                         yoschool),
         rwagp=wagp * adjinc,
         agep2=agep^2,
         exp=agep - yoschool - 6,
         exp2=exp^2,
         lwage=log(rwagp),
         sex=factor(sex, levels=1:2, labels=c("male", "female")),
         edattain=case_when(schl <= 15 ~ "notHSgrad",
                            schl %in% 16:19 ~ "HSgrad",
                            schl == 20 ~ "associate",
                            schl == 21 ~ "BA",
                            schl %in% 22:24 ~ "MA+",
                            TRUE ~ "other"),
         edattain=factor(
           edattain, 
           levels=c("notHSgrad", "HSgrad", "associate", "BA", "MA+", "other")),
         marstat=factor(
           mar, 
           levels=1:5, 
           labels=c("married", "widowed", "divorced", "separated", "neverM")))
summary(caworkers)

count(caworkers, occp, occname) %>% arrange(-n)
count(caworkers, occp, soc, occname) %>% filter(str_sub(soc, 1, 3)=="33-")

# what are HS jobs?
jobeduc <- caworkers %>%
  group_by(soc, occp, occname, edattain) %>%
  summarise(n=n(),
            pwgtp=sum(pwgtp),
            yoschool=median(yoschool, na.rm=TRUE), 
            .groups="drop") %>%
  group_by(soc, occp, occname) %>%
  summarise(n=sum(n),
            wtdn=sum(pwgtp),
            lehs=sum(pwgtp[edattain %in% c("notHSgrad", "HSgrad")]),
            assoc=sum(pwgtp[edattain %in% c("associate")]),
            ba=sum(pwgtp[edattain %in% c("BA")]),
            maplus=sum(pwgtp[edattain %in% c("MA+")]),
            .groups="drop") %>%
  mutate(across(c(lehs, assoc, ba, maplus), ~ .x / wtdn))
summary(jobeduc)
jobeduc %>% filter(str_sub(soc, 1, 3)=="33-")
# hsjobs <- jobeduc %>%
#   filter(lehspct >= .55)

caworkers2 <- caworkers %>%
  left_join(jobeduc %>%
              select(occp, lehs, assoc, ba, maplus),
            by="occp")

tmp <- caworkers2 %>%
  filter(lehs >= .6, lehs <= .7)

tmp %>%
  filter(!str_detect(occname, coll("supervisor", ignore_case = FALSE))) %>%
  group_by(soc, occp, occname) %>%
  summarise(n=n(), wtdn=sum(pwgtp), 
            across(c(lehs, assoc, ba, maplus), ~ first(.x)), 
            rwagp=wtd.mean(rwagp, weights = pwgtp)) %>%
  arrange(-rwagp)
         
```


```{r quick_regression}
glimpse(caworkers)

hsj <- jobeduc %>%
  mutate(colehs=lehs[soc=="33-3012"]) %>%
  filter(lehs >= .6, lehs <= .7, wtdn >= 5000)
  # filter(lehs >= (colehs - .05), lehs <= (colehs + .05))

mod1 <- feols(lwage ~ edattain + sex + exp + exp2 + marstat | soc, data=caworkers)
summary(mod1)

regdf <- caworkers %>% 
  filter(soc %in% hsj$soc) %>%
  mutate(female=sex=="female",
         married=marstat %in% c("married"))
count(regdf, edattain)
count(regdf, sex)
count(regdf, marstat)

mod2 <- feols(lwage ~ edattain + sex + exp + exp2 + marstat -1 | soc, data=regdf)
# mod2 <- feols(lwage ~ edattain + exp + exp2 + female + married - 1 | soc, data=regdf)
summary(mod2)  # default clusters on soc
# summary(mod2, cluster= ~ soc)

# tmp <- feols(lwage ~ edattain + sex + exp + exp2 + marstat -1 | soc, data=regdf, demeaned = TRUE)
# fixef(tmp)

# fe <- fixef(mod1)
fe <- fixef(mod2)
fe
summary(fe)
fe$soc["33-3012"]
p <- plot(fe)
p
str(p)

cfe <- tibble(soc=names(fe$soc), fe=fe$soc) %>%
  left_join(ocodes, by="soc") %>%
  mutate(cfe=fe - mean(fe)) %>% # centered fixed effects
  arrange(-cfe) %>%
  mutate(rank=row_number())

cfe %>% filter(soc=="33-3012")

```



## Corrections officers

```{r}

```

# Notes about other studies

## Hedonic wage regressions

```{r eval=FALSE}
# Biggs Illinois
# The sample is limited to individuals who work for the state government or for the private sector; federal employees or employees of non-profits are excluded. The sample also is limited to individuals who work 35 or more hours per week and 50 or more weeks per year. The model used here controls for: Years of education; Undergraduate degree field (for those with a college education and above); Potential work experience (equal to age minus years of education minus 6) and experience-squared; Broad occupation (eight categories); place of residence (based upon the Census Bureau’s Public Use Microdata Areas, or PUMAs); Usual hours of work per week; Gender; Race; Hispanicity; Marital status; Immigrant status; Year; and State government employee. Our model has several key differences that can influence the results. First, we control for the number of hours worked per week. Since Illinois state government employees work about 1.5 fewer hours per week than private sector workers, excluding weekly hours worked makes state government employees appear relatively less well paid. Second, we include a variable for the employee’s undergraduate college major, acknowledging that certain majors lead to higher pay in the workforce than others….Third, we include data on the location within the state in which the employee lives.

# Biggs Illinois
# Wages - hedonic (human capital) - ACS controls vs above:
#   state gov penalty of about 2%, w/no firm size adjustment (add'l penalty of 7.2% if firm size adjust)


```

## Benefits

```{r}
# Biggs Illinois
# p.4 notes they received unpublished ECEC in Biggs and Richwine (2014),
#   for private workers and a small number of public benefits
#   HC, RHC, and pensions drawn from specific sources
# HC:
#   IL -- Pew 2014 -- about 42% higher than private (implies ~ 20.2% of salaries I think)
#   private -- ECEC -- about 14.2% of salaries (must be for region)
# RHC:
#   IL -- NC from AV, div salaries, gives 19.4% 
#   private --  (not in the ECEC)
#     based on Biggs Richwine, which adjusted CBO, data -- nationally 0.5% NC, IL 0.48%
# Pensions:
#   IL -- tot NC of 20.9% adjusted to 41.8% using DR of 5.0% vs. earnings assump of 7.25% (appears
#         to assume 32.7 year - perhaps full career?), less eec of 5.4%,
#         leaving er NC of 36.4%
#   private -- ECEC -- er contribs of 2.6 to DC + 1.4 to DB = 4.0 erc, vs 36.4% public
# Other FB (paid leave - vacation, holiday, personal time); emp prem for life, DB; legally req
#           benefits wf wno AA rZWAM nXewm YUm QX:
#   IL -- ECEC (for region)
#   private -- ECEC (for region)

# Biggs Richwin
# HC: 
  # Our principal source is data compiled by the National Conference of State
  # Legislatures (NCSL).37 These data show monthly employer and employee health
  # premiums for individual and family coverage in 2012. In certain cases, data
  # for 2012 were not available through the NCSL. In these cases we used NCSL
  # data from prior years, adjusted upward by the rate of growth of overall
  # health premiums through 2012. In several other cases, we obtained data
  # directly from state sources, such as budget documents.
#  NCS useful


```
